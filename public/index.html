<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Telegram Bot 多Bot管理后台</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    input, button, textarea { padding: .5em; margin: .5em 0; }
    .log { margin-top: 2em; }
    textarea { width: 100%; min-height: 50px; }
    #loginBox { margin-bottom: 2em; }
    #modal { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:999; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;}
    #modal .content { background:#fff; padding:2em 3em; border-radius: 8px; }
    .chat-id-mask { font-family:monospace; font-size:0.95em; color:#555; }
    .section { margin-bottom:2em; border-bottom:1px solid #eee; }
    .bot-list { margin: 0.5em 0; }
    .bot-list-item { margin-bottom: 0.3em; }
    .delete-btn { color: #fff; background: #e74c3c; border: none; padding: 0.2em 0.7em; border-radius: 3px; margin-left: 1em; cursor:pointer;}
    .api-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .api-endpoint { font-family: monospace; background: #e9ecef; padding: 5px; border-radius: 3px; }
    .blocked-user-item { margin-bottom: 5px; display: flex; align-items: center; }
    .unblock-btn { background: #27ae60; color: white; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer; margin-left: 10px; }
    #tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
    .tab { padding: 10px 15px; cursor: pointer; }
    .tab.active { border-bottom: 2px solid #3498db; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>后台登录</h2>
    <input type="password" id="adminPwd" placeholder="请输入后台密码">
    <button onclick="login()">登录</button>
  </div>
  <div id="mainBox" style="display:none;">
    <h1>Telegram Bot 多Bot管理后台</h1>
    
    <div id="tabs">
      <div class="tab active" data-tab="main">主要功能</div>
      <div class="tab" data-tab="blocked">已停用用户</div>
      <div class="tab" data-tab="api">API文档</div>
    </div>
    
    <!-- 主要功能标签页 -->
    <div id="mainTab" class="tab-content active">
      <div class="section">
        <h2>Bot配置</h2>
        <form id="botForm">
          <label>Bot名称(用户名): <input type="text" id="bot_name" required placeholder="如 mytest_bot"></label><br>
          <label>Bot Token: <input type="text" id="bot_token" required></label><br>
          <label>管理员ID(多个用英文逗号分隔): <input type="text" id="admin_ids" required></label><br>
          <button type="submit">添加/更新Bot</button>
        </form>
        <button onclick="loadBots()">刷新Bot列表</button>
        <div id="botsDiv" class="bot-list"></div>
      </div>
      <div class="section">
        <h2>客户ID列表</h2>
        <select id="botSelect" onchange="loadCustomers()"></select>
        <button onclick="loadCustomers()">刷新客户ID</button>
        <div id="customersDiv"></div>
      </div>
      <div class="section">
        <h2>发送消息（单发）</h2>
        <form id="sendForm">
          <label>选择Bot: <select id="sendBotSelect"></select></label><br>
          <label>管理员ID: <input type="text" id="sendAdminId" required></label><br>
          <label>客户ID(可多选,用逗号分隔): <input type="text" id="sendCustomerIds" required></label><br>
          <label>内容: <textarea id="sendMsg"></textarea></label><br>
          <label>上传文件:
            <input type="file" id="sendFile">
            <select id="fileType">
              <option value="">请选择类型</option>
              <option value="photo">图片</option>
              <option value="document">普通文件</option>
            </select>
          </label><br>
          <button type="submit">发送</button>
        </form>
      </div>
      <div class="section">
        <h2>群发通知</h2>
        <form id="broadcastForm">
          <label>选择Bot: <select id="broadcastBotSelect"></select></label><br>
          <label>管理员ID: <input type="text" id="broadcastAdminId" required></label><br>
          <label>内容: <textarea id="broadcastMsg"></textarea></label><br>
          <label>上传文件:
            <input type="file" id="broadcastFile">
            <select id="broadcastFileType">
              <option value="">请选择类型</option>
              <option value="photo">图片</option>
              <option value="document">普通文件</option>
            </select>
          </label><br>
          <button type="submit">群发</button>
        </form>
      </div>
      <div class="section">
        <h2>关键词自动回复</h2>
        <label>选择Bot:
          <select id="kwBotSelect"></select>
        </label>
        <button onclick="loadKeywords()">刷新</button>
        <form id="kwForm">
          <select id="kwType">
            <option value="equal">精准匹配</option>
            <option value="contain">模糊匹配</option>
          </select>
          <input type="text" id="kwKey" placeholder="关键词">
          <input type="text" id="kwReply" placeholder="回复内容">
          <button type="submit">添加关键词</button>
        </form>
        <div id="kwList"></div>
      </div>
      <div class="section">
        <h2>启动消息设置</h2>
        <label>选择Bot:
          <select id="startMsgBotSelect"></select>
        </label>
        <form id="startMsgForm">
          <select id="startMsgType">
            <option value="none">纯文字</option>
            <option value="photo">图片</option>
          </select>
          <label id="photoUrlLabel" style="display:inline;">
            图片链接（上传到 <a href="https://image.a5fe.com/" target="_blank">图床</a> 后粘贴链接）:
            <input type="text" id="startMsgPhotoUrl" placeholder="https://image.a5fe.com/xxx.jpg">
          </label>
          <textarea id="startMsgText" placeholder="请输入启动欢迎语"></textarea>
          <button type="submit">保存</button>
        </form>
      </div>
    </div>
    
    <!-- 已停用用户标签页 -->
    <div id="blockedTab" class="tab-content">
      <h2>已停用机器人的用户列表</h2>
      <p>这些用户已经停用或删除了机器人，向他们发送消息会失败</p>
      <label>选择Bot:
        <select id="blockedBotSelect" onchange="loadBlockedUsers()"></select>
      </label>
      <button onclick="loadBlockedUsers()">刷新列表</button>
      <div id="blockedUsersDiv"></div>
    </div>
    
    <!-- API文档标签页 -->
    <div id="apiTab" class="tab-content">
      <h2>API文档</h2>
      <p>所有API请求都需要通过api_pass参数验证身份，可以在请求体中传递</p>
      
      <div class="api-section">
        <h3>1. 登录验证</h3>
        <p><span class="api-endpoint">POST /api/login</span></p>
        <pre>
请求体:
{
  "password": "您的管理密码"
}

响应:
{
  "ok": true|false
}
        </pre>
      </div>
      
      <div class="api-section">
        <h3>2. Bot管理</h3>
        <p><span class="api-endpoint">GET /api/bots</span> - 获取所有Bot配置</p>
        <p><span class="api-endpoint">POST /api/bots</span> - 添加/更新Bot</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "token": "bot的token",
  "admins": ["管理员ID1", "管理员ID2"]
}
        </pre>
        <p><span class="api-endpoint">DELETE /api/bots</span> - 删除Bot</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "要删除的bot用户名"
}
        </pre>
      </div>
      
      <div class="api-section">
        <h3>3. 客户管理</h3>
        <p><span class="api-endpoint">GET /api/customers/{bot_name}</span> - 获取该Bot的所有客户ID</p>
        <p><span class="api-endpoint">GET /api/blocked?bot_name={bot_name}</span> - 获取已停用Bot的用户</p>
        <p><span class="api-endpoint">POST /api/blocked</span> - 添加停用用户</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "user_id": "用户ID"
}
        </pre>
        <p><span class="api-endpoint">DELETE /api/blocked</span> - 移除停用用户</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "user_id": "用户ID"
}
        </pre>
      </div>
      
      <div class="api-section">
        <h3>4. 消息发送</h3>
        <p><span class="api-endpoint">POST /api/send</span> - 发送单条消息</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "admin_id": "管理员ID",
  "customer_ids": ["用户ID1", "用户ID2"],
  "text": "消息内容",
  "fileType": "photo|document", // 可选
  "fileUrl": "文件URL"  // 可选
}
        </pre>
        <p><span class="api-endpoint">POST /api/broadcast</span> - 群发消息</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "admin_id": "管理员ID",
  "text": "消息内容",
  "fileType": "photo|document", // 可选
  "fileUrl": "文件URL"  // 可选
}
        </pre>
      </div>
      
      <div class="api-section">
        <h3>5. 启动消息管理</h3>
        <p><span class="api-endpoint">GET /api/startmsg?bot_name={bot_name}</span> - 获取启动消息配置</p>
        <p><span class="api-endpoint">POST /api/startmsg</span> - 设置启动消息</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "type": "none|photo",
  "fileUrl": "图片链接",  // 如果type为photo
  "caption": "消息文本"
}
        </pre>
      </div>
      
      <div class="api-section">
        <h3>6. 关键词管理</h3>
        <p><span class="api-endpoint">GET /api/keywords?bot_name={bot_name}</span> - 获取关键词列表</p>
        <p><span class="api-endpoint">POST /api/keywords</span> - 添加关键词</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "type": "equal|contain",
  "keyword": "关键词",
  "reply": "回复内容"
}
        </pre>
        <p><span class="api-endpoint">DELETE /api/keywords</span> - 删除关键词</p>
        <pre>
请求体:
{
  "api_pass": "您的管理密码",
  "bot_name": "bot用户名",
  "idx": 关键词索引
}
        </pre>
      </div>
    </div>
  </div>
  <div id="modal">
    <div class="content" id="modalContent"></div>
  </div>
  <script>
    // 配置
    const workerApiBase = "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api";
    let api_pass = localStorage.getItem('adminApiPass') || "";

    function showMain() {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainBox').style.display = '';
      loadBots();
    }
    function showLogin() {
      document.getElementById('loginBox').style.display = '';
      document.getElementById('mainBox').style.display = 'none';
    }
    async function login() {
      const pwd = document.getElementById('adminPwd').value;
      if(!pwd) return showModal('请输入密码');
      const res = await fetch(workerApiBase + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pwd })
      });
      const data = await res.json();
      if(data.ok) {
        localStorage.setItem('adminApiPass', pwd);
        api_pass = pwd;
        showMain();
      } else {
        showModal('密码错误');
      }
    }
    function showModal(msg) {
      document.getElementById('modalContent').innerText = msg;
      document.getElementById('modal').style.display = 'flex';
    }
    document.getElementById('modal').onclick = function(){this.style.display='none'};

    // 标签页切换
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // 切换标签样式
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // 切换内容
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        if (tabName === 'main') {
          document.getElementById('mainTab').classList.add('active');
        } else if (tabName === 'blocked') {
          document.getElementById('blockedTab').classList.add('active');
          loadBlockedUsers();
        } else if (tabName === 'api') {
          document.getElementById('apiTab').classList.add('active');
        }
      });
    });

    let botsCache = {};
    async function loadBots() {
      const res = await fetch(workerApiBase + "/bots");
      const bots = await res.json();
      botsCache = bots;
      let html = '<ul>';
      for(const k in bots){
        html += `<li class="bot-list-item"><b>${k}</b> Token: ${bots[k].token.slice(0,8)}... 管理员: ${bots[k].admins.join(",")}
         <button class="delete-btn" onclick="deleteBot('${k}')">删除</button></li>`;
      }
      html += '</ul>';
      document.getElementById('botsDiv').innerHTML = html;
      let options = '';
      for(const k in bots) options += `<option value="${k}">${k}</option>`;
      document.getElementById('botSelect').innerHTML = options;
      document.getElementById('sendBotSelect').innerHTML = options;
      document.getElementById('broadcastBotSelect').innerHTML = options;
      document.getElementById('kwBotSelect').innerHTML = options;
      document.getElementById('startMsgBotSelect').innerHTML = options;
      document.getElementById('blockedBotSelect').innerHTML = options;
      loadStartMsg();
      loadBlockedUsers();
    }
    async function deleteBot(bot_name) {
      if(!confirm('确定要删除Bot：'+bot_name+'？')) return;
      const res = await fetch(workerApiBase + "/bots", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('Bot已删除!');
        loadBots();
      } else {
        showModal('删除失败:'+d.error);
      }
    }
    document.getElementById('botForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('bot_name').value;
      const token = document.getElementById('bot_token').value;
      const admins = document.getElementById('admin_ids').value.split(",").map(v=>v.trim()).filter(Boolean);
      const res = await fetch(workerApiBase + "/bots", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,token,admins})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('Bot配置成功!');
        loadBots();
      } else {
        showModal('配置失败:'+d.error);
      }
    };

    async function loadCustomers() {
      const bot_name = document.getElementById('botSelect').value;
      const res = await fetch(workerApiBase + `/customers/${encodeURIComponent(bot_name)}`);
      const list = await res.json();
      let html = '<ul>';
      for(const id of list){
        html += `<li>${id} <button onclick="document.getElementById('sendCustomerIds').value='${id}';">填入</button></li>`;
      }
      html += '</ul>';
      document.getElementById('customersDiv').innerHTML = html;
    }

    document.getElementById('sendForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('sendBotSelect').value;
      const admin_id = document.getElementById('sendAdminId').value.trim();
      const customer_ids = document.getElementById('sendCustomerIds').value.split(",").map(v=>v.trim()).filter(Boolean);
      const text = document.getElementById('sendMsg').value;
      const fileInput = document.getElementById('sendFile');
      const fileType = document.getElementById('fileType').value;
      let fileUrl = "";
      const botsRes = await fetch(workerApiBase + "/bots");
      const bots = await botsRes.json();
      const botToken = bots[bot_name].token;

      if(fileInput.files.length && fileType){
        // 这里依然调用Telegram上传接口（sendPhoto/sendDocument）
        const form = new FormData();
        if(fileType === "photo") form.append("photo", fileInput.files[0]);
        else form.append("document", fileInput.files[0]);
        form.append("chat_id", admin_id);
        const resUpload = await fetch(`https://api.telegram.org/bot${botToken}/${fileType === "photo" ? "sendPhoto" : "sendDocument"}`, {method:"POST", body: form});
        const data = await resUpload.json();
        if(fileType === "photo" && data && data.result) fileUrl = data.result.photo[data.result.photo.length-1].file_id;
        if(fileType === "document" && data && data.result) fileUrl = data.result.document.file_id;
        if(!fileUrl) {
          showModal('文件上传失败');
          return;
        }
      }

      const res = await fetch(workerApiBase + "/send", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,admin_id,customer_ids,text,fileType,fileUrl})
      });
      const d = await res.json();
      if(d.ok) {
        // 检查是否有发送失败的消息
        let failedMessages = d.results.filter(r => !r.ok && r.error === "用户停止了机器人或删除了账户");
        if (failedMessages.length > 0) {
          showModal(`部分消息发送失败: ${failedMessages.length}条消息未发送，因为用户已停用机器人`);
        } else {
          showModal('消息已发送!');
        }
      }
      else showModal('发送失败:'+(d.error||JSON.stringify(d)));
    };

    // 群发通知
    document.getElementById('broadcastForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('broadcastBotSelect').value;
      const admin_id = document.getElementById('broadcastAdminId').value.trim();
      const text = document.getElementById('broadcastMsg').value;
      const fileInput = document.getElementById('broadcastFile');
      const fileType = document.getElementById('broadcastFileType').value;
      let fileUrl = "";
      const botsRes = await fetch(workerApiBase + "/bots");
      const bots = await botsRes.json();
      const botToken = bots[bot_name].token;

      if(fileInput.files.length && fileType){
        const form = new FormData();
        if(fileType === "photo") form.append("photo", fileInput.files[0]);
        else form.append("document", fileInput.files[0]);
        form.append("chat_id", admin_id);
        const resUpload = await fetch(`https://api.telegram.org/bot${botToken}/${fileType === "photo" ? "sendPhoto" : "sendDocument"}`, {method:"POST", body: form});
        const data = await resUpload.json();
        if(fileType === "photo" && data && data.result) fileUrl = data.result.photo[data.result.photo.length-1].file_id;
        if(fileType === "document" && data && data.result) fileUrl = data.result.document.file_id;
        if(!fileUrl) {
          showModal('文件上传失败');
          return;
        }
      }

      const res = await fetch(workerApiBase + "/broadcast", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,admin_id,text,fileType,fileUrl})
      });
      const d = await res.json();
      if(d.ok) showModal('群发成功！本次发送：'+d.count+'人');
      else showModal('群发失败:'+(d.error||JSON.stringify(d)));
    };

    // 关键词自动回复
    async function loadKeywords() {
      const bot_name = document.getElementById('kwBotSelect').value;
      const res = await fetch(workerApiBase + `/keywords?bot_name=${encodeURIComponent(bot_name)}`);
      const keywords = await res.json();
      let html = '<ul>';
      for(const [i, kw] of keywords.entries()) {
        html += `<li>[${kw.type==='equal'?'精准':'模糊'}] <b>${kw.keyword}</b> → ${kw.reply}
          <button onclick="deleteKeyword(${i})">删除</button></li>`;
      }
      html += '</ul>';
      document.getElementById('kwList').innerHTML = html;
    }
    document.getElementById('kwForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('kwBotSelect').value;
      const type = document.getElementById('kwType').value;
      const keyword = document.getElementById('kwKey').value.trim();
      const reply = document.getElementById('kwReply').value.trim();
      if(!keyword||!reply) return showModal('关键词和回复内容必填');
      const res = await fetch(workerApiBase + "/keywords", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,type,keyword,reply})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('添加成功');
        loadKeywords();
      } else {
        showModal('添加失败:'+d.error);
      }
    };
    async function deleteKeyword(idx) {
      const bot_name = document.getElementById('kwBotSelect').value;
      if(!confirm('确定删除该关键词？')) return;
      await fetch(workerApiBase + "/keywords", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,idx})
      });
      loadKeywords();
    }

    // 启动消息管理
    async function loadStartMsg() {
      const bot_name = document.getElementById('startMsgBotSelect').value;
      if(!bot_name) return;
      const res = await fetch(workerApiBase + `/startmsg?bot_name=${encodeURIComponent(bot_name)}`);
      const d = await res.json();
      document.getElementById('startMsgType').value = d.type || "none";
      document.getElementById('startMsgPhotoUrl').value = d.fileUrl || "";
      document.getElementById('startMsgText').value = d.caption || "";
    }
    document.getElementById('startMsgBotSelect').onchange = loadStartMsg;
    document.getElementById('startMsgForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('startMsgBotSelect').value;
      const type = document.getElementById('startMsgType').value;
      const caption = document.getElementById('startMsgText').value;
      const fileUrl = document.getElementById('startMsgPhotoUrl').value.trim();
      if(type === "photo" && !fileUrl) {
        showModal('请粘贴经过图床上传后的图片链接');
        return;
      }
      const res = await fetch(workerApiBase + "/startmsg", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,type,fileUrl,caption})
      });
      const d = await res.json();
      if(d.ok) showModal('启动消息已保存');
      else showModal('保存失败:'+d.error);
    };
    
    // 已停用用户管理
    async function loadBlockedUsers() {
      const bot_name = document.getElementById('blockedBotSelect').value;
      if (!bot_name) return;
      
      const res = await fetch(workerApiBase + `/blocked?bot_name=${encodeURIComponent(bot_name)}`);
      const blockedUsers = await res.json();
      
      let html = '';
      if (blockedUsers && blockedUsers.length > 0) {
        html = '<ul>';
        for(const user_id of blockedUsers) {
          html += `
          <li class="blocked-user-item">
            <span>用户ID: ${user_id}</span>
            <button class="unblock-btn" onclick="unblockUser('${bot_name}', '${user_id}')">移除</button>
          </li>`;
        }
        html += '</ul>';
      } else {
        html = '<p>没有已停用机器人的用户</p>';
      }
      
      document.getElementById('blockedUsersDiv').innerHTML = html;
    }
    
    async function unblockUser(bot_name, user_id) {
      if (!confirm(`确定要将用户 ${user_id} 从停用列表中移除吗？`)) return;
      
      const res = await fetch(workerApiBase + "/blocked", {
        method: "DELETE",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({api_pass, bot_name, user_id})
      });
      
      const data = await res.json();
      if (data.ok) {
        showModal("用户已从停用列表中移除");
        loadBlockedUsers();
      } else {
        showModal("操作失败: " + (data.error || "未知错误"));
      }
    }

    window.onload = function(){
      if(api_pass) showMain();
      else showLogin();
    }
  </script>
</body>
</html>
