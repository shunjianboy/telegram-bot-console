<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot 管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-container {
            margin-top: 40px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: none;
        }
        .navbar {
            margin-bottom: 20px;
        }
        .tab-content {
            padding-top: 20px;
        }
        .alert {
            margin: 15px 0;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .bot-card {
            margin-bottom: 15px;
        }
        .keyword-item {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        #page-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="page-loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>
    
    <!-- 登录界面 -->
    <div class="container login-container" id="login-page">
        <h2 class="text-center mb-4">Telegram Bot 管理后台登录</h2>
        <div class="mb-3">
            <label for="password" class="form-label">管理密码</label>
            <input type="password" class="form-control" id="password">
        </div>
        <button class="btn btn-primary w-100" id="login-btn">登录</button>
        <div id="login-error" class="alert alert-danger mt-3" style="display: none;">密码错误，请重试</div>
        <div id="network-error" class="alert alert-danger mt-3" style="display: none;">网络错误，请重试</div>
    </div>
    
    <!-- 主界面 -->
    <div class="container main-container" id="main-page">
        <h2 class="text-center mb-4">Telegram Bot 管理后台</h2>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="bots-tab" data-bs-toggle="tab" data-bs-target="#bots" type="button" role="tab">Bot 管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="keywords-tab" data-bs-toggle="tab" data-bs-target="#keywords" type="button" role="tab">关键词回复</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="startmsg-tab" data-bs-toggle="tab" data-bs-target="#startmsg" type="button" role="tab">启动消息</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcast" type="button" role="tab">群发消息</button>
            </li>
            <li class="nav-item ms-auto">
                <button class="btn btn-sm btn-outline-danger" id="logout-btn">退出登录</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Bot 管理标签 -->
            <div class="tab-pane fade show active" id="bots" role="tabpanel">
                <h4>Bot 列表</h4>
                <div id="bot-list" class="mt-3"></div>
                
                <div class="card mt-4">
                    <div class="card-header">添加新 Bot</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="new-bot-name" class="form-label">Bot 名称</label>
                            <input type="text" class="form-control" id="new-bot-name">
                        </div>
                        <div class="mb-3">
                            <label for="new-bot-token" class="form-label">Bot Token</label>
                            <input type="text" class="form-control" id="new-bot-token">
                        </div>
                        <div class="mb-3">
                            <label for="new-bot-admins" class="form-label">管理员ID (多个ID用逗号分隔)</label>
                            <input type="text" class="form-control" id="new-bot-admins">
                        </div>
                        <button class="btn btn-primary" id="add-bot-btn">添加 Bot</button>
                    </div>
                </div>
            </div>
            
            <!-- 关键词回复标签 -->
            <div class="tab-pane fade" id="keywords" role="tabpanel">
                <div class="mb-3">
                    <label for="keyword-bot-select" class="form-label">选择 Bot</label>
                    <select class="form-select" id="keyword-bot-select"></select>
                </div>
                
                <div id="keywords-list" class="mt-3"></div>
                
                <div class="card mt-4">
                    <div class="card-header">添加新关键词</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">匹配类型</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="keywordType" id="type-equal" value="equal" checked>
                                <label class="form-check-label" for="type-equal">
                                    完全匹配
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="keywordType" id="type-contain" value="contain">
                                <label class="form-check-label" for="type-contain">
                                    包含
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="new-keyword" class="form-label">关键词</label>
                            <input type="text" class="form-control" id="new-keyword">
                        </div>
                        <div class="mb-3">
                            <label for="new-reply" class="form-label">回复内容</label>
                            <textarea class="form-control" id="new-reply" rows="3"></textarea>
                        </div>
                        <button class="btn btn-primary" id="add-keyword-btn">添加关键词</button>
                    </div>
                </div>
            </div>
            
            <!-- 启动消息标签 -->
            <div class="tab-pane fade" id="startmsg" role="tabpanel">
                <div class="mb-3">
                    <label for="startmsg-bot-select" class="form-label">选择 Bot</label>
                    <select class="form-select" id="startmsg-bot-select"></select>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">设置启动消息</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">消息类型</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="startMsgType" id="type-none" value="none">
                                <label class="form-check-label" for="type-none">
                                    无特殊启动消息
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="startMsgType" id="type-text" value="text" checked>
                                <label class="form-check-label" for="type-text">
                                    纯文本
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="startMsgType" id="type-photo" value="photo">
                                <label class="form-check-label" for="type-photo">
                                    图片
                                </label>
                            </div>
                        </div>
                        <div id="fileUrl-group" class="mb-3" style="display: none;">
                            <label for="startmsg-fileurl" class="form-label">图片URL</label>
                            <input type="text" class="form-control" id="startmsg-fileurl">
                        </div>
                        <div class="mb-3">
                            <label for="startmsg-text" class="form-label">消息内容/图片说明</label>
                            <textarea class="form-control" id="startmsg-text" rows="3"></textarea>
                        </div>
                        <button class="btn btn-primary" id="save-startmsg-btn">保存设置</button>
                    </div>
                </div>
            </div>
            
            <!-- 群发消息标签 -->
            <div class="tab-pane fade" id="broadcast" role="tabpanel">
                <div class="mb-3">
                    <label for="broadcast-bot-select" class="form-label">选择 Bot</label>
                    <select class="form-select" id="broadcast-bot-select"></select>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">群发消息</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">消息类型</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="broadcastType" id="broadcast-type-text" value="text" checked>
                                <label class="form-check-label" for="broadcast-type-text">
                                    纯文本
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="broadcastType" id="broadcast-type-photo" value="photo">
                                <label class="form-check-label" for="broadcast-type-photo">
                                    图片
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="broadcastType" id="broadcast-type-document" value="document">
                                <label class="form-check-label" for="broadcast-type-document">
                                    文件
                                </label>
                            </div>
                        </div>
                        <div id="broadcast-fileurl-group" class="mb-3" style="display: none;">
                            <label for="broadcast-fileurl" class="form-label">文件/图片URL</label>
                            <input type="text" class="form-control" id="broadcast-fileurl">
                        </div>
                        <div class="mb-3">
                            <label for="broadcast-text" class="form-label">消息内容/图片说明</label>
                            <textarea class="form-control" id="broadcast-text" rows="3"></textarea>
                        </div>
                        <button class="btn btn-primary" id="send-broadcast-btn">发送给所有用户</button>
                        <div id="broadcast-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 配置API基础URL - 这里需要根据实际情况修改为您的Workers API地址
        const API_BASE_URL = "https://telegram-bot-api.shunjianboy-e0e.workers.dev";
        // 如果API和页面在同一个域，可以使用相对路径
        // const API_BASE_URL = "";
        
        // 保存登录状态
        let isLoggedIn = false;
        let adminPassword = "";
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已登录
            const savedPassword = localStorage.getItem('tgbot_admin_pass');
            if (savedPassword) {
                adminPassword = savedPassword;
                checkLogin(savedPassword);
            } else {
                // 隐藏加载动画
                document.getElementById('page-loading').style.display = 'none';
            }
            
            // 登录按钮事件
            document.getElementById('login-btn').addEventListener('click', function() {
                const password = document.getElementById('password').value;
                if (!password) return;
                
                login(password);
            });
            
            // 密码输入框回车事件
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const password = document.getElementById('password').value;
                    if (!password) return;
                    
                    login(password);
                }
            });
            
            // 登出按钮事件
            document.getElementById('logout-btn').addEventListener('click', function() {
                logout();
            });
            
            // 添加Bot按钮事件
            document.getElementById('add-bot-btn').addEventListener('click', function() {
                addNewBot();
            });
            
            // 关键词标签点击时加载关键词
            document.getElementById('keywords-tab').addEventListener('click', function() {
                loadBotSelectOptions('keyword-bot-select');
            });
            
            // Bot选择框变化时加载关键词
            document.getElementById('keyword-bot-select').addEventListener('change', function() {
                loadKeywords(this.value);
            });
            
            // 添加关键词按钮事件
            document.getElementById('add-keyword-btn').addEventListener('click', function() {
                addNewKeyword();
            });
            
            // 启动消息标签点击时加载Bot列表
            document.getElementById('startmsg-tab').addEventListener('click', function() {
                loadBotSelectOptions('startmsg-bot-select');
            });
            
            // Bot选择框变化时加载启动消息
            document.getElementById('startmsg-bot-select').addEventListener('change', function() {
                loadStartMsg(this.value);
            });
            
            // 启动消息类型变化时显示/隐藏文件URL输入框
            document.querySelectorAll('input[name="startMsgType"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.value === 'photo') {
                        document.getElementById('fileUrl-group').style.display = 'block';
                    } else {
                        document.getElementById('fileUrl-group').style.display = 'none';
                    }
                });
            });
            
            // 保存启动消息按钮事件
            document.getElementById('save-startmsg-btn').addEventListener('click', function() {
                saveStartMsg();
            });
            
            // 群发消息标签点击时加载Bot列表
            document.getElementById('broadcast-tab').addEventListener('click', function() {
                loadBotSelectOptions('broadcast-bot-select');
            });
            
            // 群发消息类型变化时显示/隐藏文件URL输入框
            document.querySelectorAll('input[name="broadcastType"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.value === 'text') {
                        document.getElementById('broadcast-fileurl-group').style.display = 'none';
                    } else {
                        document.getElementById('broadcast-fileurl-group').style.display = 'block';
                    }
                });
            });
            
            // 发送群发消息按钮事件
            document.getElementById('send-broadcast-btn').addEventListener('click', function() {
                sendBroadcast();
            });
        });
        
        // 检查登录状态
        function checkLogin(password) {
            fetch(`${API_BASE_URL}/api/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: password})
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    adminPassword = password;
                    localStorage.setItem('tgbot_admin_pass', password);
                    isLoggedIn = true;
                    showMainPage();
                    loadBots();
                } else {
                    document.getElementById('page-loading').style.display = 'none';
                    localStorage.removeItem('tgbot_admin_pass');
                }
            })
            .catch(error => {
                console.error('检查登录状态错误:', error);
                document.getElementById('page-loading').style.display = 'none';
                localStorage.removeItem('tgbot_admin_pass');
            });
        }
        
        // 登录
        function login(password) {
            // 显示加载动画
            document.getElementById('login-btn').innerHTML = '登录中... <div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('login-btn').disabled = true;
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('network-error').style.display = 'none';
            
            fetch(`${API_BASE_URL}/api/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: password})
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    adminPassword = password;
                    localStorage.setItem('tgbot_admin_pass', password);
                    isLoggedIn = true;
                    showMainPage();
                    loadBots();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-btn').innerHTML = '登录';
                    document.getElementById('login-btn').disabled = false;
                }
            })
            .catch(error => {
                console.error('登录错误:', error);
                document.getElementById('network-error').style.display = 'block';
                document.getElementById('login-btn').innerHTML = '登录';
                document.getElementById('login-btn').disabled = false;
            });
        }
        
        // 登出
        function logout() {
            localStorage.removeItem('tgbot_admin_pass');
            isLoggedIn = false;
            adminPassword = "";
            showLoginPage();
        }
        
        // 显示主页面
        function showMainPage() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            document.getElementById('page-loading').style.display = 'none';
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('main-page').style.display = 'none';
            document.getElementById('password').value = '';
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('network-error').style.display = 'none';
        }
        
        // 加载Bot列表
        function loadBots() {
            showLoading('bot-list', '加载Bot列表...');
            
            fetch(`${API_BASE_URL}/api/bots`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                displayBots(data);
            })
            .catch(error => {
                console.error('加载Bot列表错误:', error);
                document.getElementById('bot-list').innerHTML = '<div class="alert alert-danger">加载Bot列表失败，请刷新页面重试</div>';
            });
        }
        
        // 显示Bot列表
        function displayBots(bots) {
            const botList = document.getElementById('bot-list');
            if (!bots || Object.keys(bots).length === 0) {
                botList.innerHTML = '<div class="alert alert-info">暂无Bot，请添加</div>';
                return;
            }
            
            let html = '';
            for (const [botName, botData] of Object.entries(bots)) {
                html += `
                <div class="card bot-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${botName}</h5>
                        <button class="btn btn-sm btn-danger delete-bot" data-bot="${botName}">删除</button>
                    </div>
                    <div class="card-body">
                        <p><strong>Token:</strong> ${botData.token}</p>
                        <p><strong>管理员ID:</strong> ${botData.admins.join(', ')}</p>
                    </div>
                </div>
                `;
            }
            botList.innerHTML = html;
            
            // 为删除按钮添加事件
            document.querySelectorAll('.delete-bot').forEach(button => {
                button.addEventListener('click', function() {
                    const botName = this.getAttribute('data-bot');
                    if (confirm(`确认删除 Bot "${botName}"?`)) {
                        deleteBot(botName);
                    }
                });
            });
        }
        
        // 添加新Bot
        function addNewBot() {
            const botName = document.getElementById('new-bot-name').value.trim();
            const botToken = document.getElementById('new-bot-token').value.trim();
            const botAdmins = document.getElementById('new-bot-admins').value.trim();
            
            if (!botName || !botToken || !botAdmins) {
                alert('请填写完整的Bot信息');
                return;
            }
            
            const adminsArray = botAdmins.split(',').map(id => id.trim());
            
            document.getElementById('add-bot-btn').innerHTML = '添加中... <div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('add-bot-btn').disabled = true;
            
            fetch(`${API_BASE_URL}/api/bots`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_pass: adminPassword,
                    bot_name: botName,
                    token: botToken,
                    admins: adminsArray
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('add-bot-btn').innerHTML = '添加 Bot';
                document.getElementById('add-bot-btn').disabled = false;
                
                if (data.ok) {
                    document.getElementById('new-bot-name').value = '';
                    document.getElementById('new-bot-token').value = '';
                    document.getElementById('new-bot-admins').value = '';
                    
                    loadBots();
                    if (data.warning) {
                        alert('Bot已添加，但' + data.warning);
                    } else {
                        alert('Bot添加成功');
                    }
                } else {
                    alert('添加Bot失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('添加Bot错误:', error);
                document.getElementById('add-bot-btn').innerHTML = '添加 Bot';
                document.getElementById('add-bot-btn').disabled = false;
                alert('网络错误，请重试');
            });
        }
        
        // 删除Bot
        function deleteBot(botName) {
            fetch(`${API_BASE_URL}/api/bots`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_pass: adminPassword,
                    bot_name: botName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    loadBots();
                    alert('Bot删除成功');
                } else {
                    alert('删除Bot失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('删除Bot错误:', error);
                alert('网络错误，请重试');
            });
        }
        
        // 加载Bot选择框选项
        function loadBotSelectOptions(selectId) {
            const select = document.getElementById(selectId);
            
            fetch(`${API_BASE_URL}/api/bots`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                let html = '<option value="">请选择一个Bot</option>';
                for (const botName in data) {
                    html += `<option value="${botName}">${botName}</option>`;
                }
                select.innerHTML = html;
                
                // 如果是关键词选择框，触发变化事件加载关键词
                if (selectId === 'keyword-bot-select' && select.value) {
                    loadKeywords(select.value);
                }
                // 如果是启动消息选择框，触发变化事件加载启动消息
                if (selectId === 'startmsg-bot-select' && select.value) {
                    loadStartMsg(select.value);
                }
            })
            .catch(error => {
                console.error('加载Bot选择框选项错误:', error);
                select.innerHTML = '<option value="">加载Bot列表失败</option>';
            });
        }
        
        // 加载关键词
        function loadKeywords(botName) {
            if (!botName) return;
            
            const keywordsList = document.getElementById('keywords-list');
            showLoading('keywords-list', '加载关键词列表...');
            
            fetch(`${API_BASE_URL}/api/keywords?bot_name=${encodeURIComponent(botName)}`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                displayKeywords(data, botName);
            })
            .catch(error => {
                console.error('加载关键词错误:', error);
                keywordsList.innerHTML = '<div class="alert alert-danger">加载关键词失败，请刷新页面重试</div>';
            });
        }
        
        // 显示关键词列表
        function displayKeywords(keywords, botName) {
            const keywordsList = document.getElementById('keywords-list');
            if (!keywords || keywords.length === 0) {
                keywordsList.innerHTML = '<div class="alert alert-info">该Bot暂无关键词，请添加</div>';
                return;
            }
            
            let html = '';
            keywords.forEach((keyword, index) => {
                html += `
                <div class="keyword-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>关键词:</strong> ${keyword.keyword}
                            <span class="badge bg-secondary">${keyword.type === 'equal' ? '完全匹配' : '包含'}</span>
                        </div>
                        <button class="btn btn-sm btn-danger delete-keyword" data-bot="${botName}" data-idx="${index}">删除</button>
                    </div>
                    <div class="mt-2">
                        <strong>回复:</strong> ${keyword.reply}
                    </div>
                </div>
                `;
            });
            keywordsList.innerHTML = html;
            
            // 为删除按钮添加事件
            document.querySelectorAll('.delete-keyword').forEach(button => {
                button.addEventListener('click', function() {
                    const botName = this.getAttribute('data-bot');
                    const idx = this.getAttribute('data-idx');
                    if (confirm('确认删除此关键词?')) {
                        deleteKeyword(botName, idx);
                    }
                });
            });
        }
        
        // 添加新关键词
        function addNewKeyword() {
            const botName = document.getElementById('keyword-bot-select').value;
            if (!botName) {
                alert('请选择一个Bot');
                return;
            }
            
            const type = document.querySelector('input[name="keywordType"]:checked').value;
            const keyword = document.getElementById('new-keyword').value.trim();
            const reply = document.getElementById('new-reply').value.trim();
            
            if (!keyword || !reply) {
                alert('请填写关键词和回复内容');
                return;
            }
            
            document.getElementById('add-keyword-btn').innerHTML = '添加中... <div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('add-keyword-btn').disabled = true;
            
            fetch(`${API_BASE_URL}/api/keywords`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_pass: adminPassword,
                    bot_name: botName,
                    type: type,
                    keyword: keyword,
                    reply: reply
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('add-keyword-btn').innerHTML = '添加关键词';
                document.getElementById('add-keyword-btn').disabled = false;
                
                if (data.ok) {
                    document.getElementById('new-keyword').value = '';
                    document.getElementById('new-reply').value = '';
                    
                    loadKeywords(botName);
                    alert('关键词添加成功');
                } else {
                    alert('添加关键词失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('添加关键词错误:', error);
                document.getElementById('add-keyword-btn').innerHTML = '添加关键词';
                document.getElementById('add-keyword-btn').disabled = false;
                alert('网络错误，请重试');
            });
        }
        
        // 删除关键词
        function deleteKeyword(botName, idx) {
            fetch(`${API_BASE_URL}/api/keywords`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_pass: adminPassword,
                    bot_name: botName,
                    idx: parseInt(idx)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    loadKeywords(botName);
                    alert('关键词删除成功');
                } else {
                    alert('删除关键词失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('删除关键词错误:', error);
                alert('网络错误，请重试');
            });
        }
        
        // 加载启动消息
        function loadStartMsg(botName) {
            if (!botName) return;
            
            fetch(`${API_BASE_URL}/api/startmsg?bot_name=${encodeURIComponent(botName)}`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                // 设置表单值
                const typeRadio = document.querySelector(`input[name="startMsgType"][value="${data.type || 'none'}"]`);
                if (typeRadio) typeRadio.checked = true;
                
                document.getElementById('startmsg-fileurl').value = data.fileUrl || '';
                document.getElementById('startmsg-text').value = data.caption || '';
                
                // 显示/隐藏文件URL输入框
                if (data.type === 'photo') {
                    document.getElementById('fileUrl-group').style.display = 'block';
                } else {
                    document.getElementById('fileUrl-group').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('加载启动消息错误:', error);
                alert('加载启动消息失败，请重试');
            });
        }
        
        // 保存启动消息
        function saveStartMsg() {
            const botName = document.getElementById('startmsg-bot-select').value;
            if (!botName) {
                alert('请选择一个Bot');
                return;
            }
            
            const type = document.querySelector('input[name="startMsgType"]:checked').value;
            const fileUrl = document.getElementById('startmsg-fileurl').value.trim();
            const caption = document.getElementById('startmsg-text').value.trim();
            
            if (type === 'photo' && !fileUrl) {
                alert('请填写图片URL');
                return;
            }
            
            document.getElementById('save-startmsg-btn').innerHTML = '保存中... <div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('save-startmsg-btn').disabled = true;
            
            fetch(`${API_BASE_URL}/api/startmsg`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_pass: adminPassword,
                    bot_name: botName,
                    type: type,
                    fileUrl: fileUrl,
                    caption: caption
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('save-startmsg-btn').innerHTML = '保存设置';
                document.getElementById('save-startmsg-btn').disabled = false;
                
                if (data.ok) {
                    alert('启动消息保存成功');
                } else {
                    alert('保存启动消息失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('保存启动消息错误:', error);
                document.getElementById('save-startmsg-btn').innerHTML = '保存设置';
                document.getElementById('save-startmsg-btn').disabled = false;
                alert('网络错误，请重试');
            });
        }
        
        // 发送群发消息
        function sendBroadcast() {
            const botName = document.getElementById('broadcast-bot-select').value;
            if (!botName) {
                alert('请选择一个Bot');
                return;
            }
            
            const fileType = document.querySelector('input[name="broadcastType"]:checked').value;
            const fileUrl = document.getElementById('broadcast-fileurl').value.trim();
            const text = document.getElementById('broadcast-text').value.trim();
            
            if ((fileType === 'photo' || fileType === 'document') && !fileUrl) {
                alert('请填写文件/图片URL');
                return;
            }
            
            if (fileType === 'text' && !text) {
                alert('请填写消息内容');
                return;
            }
            
            if (!confirm('确认向该Bot的所有用户发送消息?')) {
                return;
            }
            
            document.getElementById('send-broadcast-btn').innerHTML = '发送中... <div class="spinner-border spinner-border-sm" role="status"></div>';
            document.getElementById('send-broadcast-btn').disabled = true;
            document.getElementById('broadcast-result').innerHTML = '';
            
            fetch(`${API_BASE_URL}/api/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_pass: adminPassword,
                    bot_name: botName,
                    admin_id: "0", // 这里使用0作为管理员ID，实际应该是真实的管理员ID
                    text: text,
                    fileType: fileType === 'text' ? null : fileType,
                    fileUrl: fileType === 'text' ? null : fileUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('send-broadcast-btn').innerHTML = '发送给所有用户';
                document.getElementById('send-broadcast-btn').disabled = false;
                
                if (data.ok) {
                    document.getElementById('broadcast-result').innerHTML = `
                        <div class="alert alert-success">
                            消息已成功发送给 ${data.count} 个用户
                        </div>
                    `;
                } else {
                    document.getElementById('broadcast-result').innerHTML = `
                        <div class="alert alert-danger">
                            发送失败: ${data.error || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('发送群发消息错误:', error);
                document.getElementById('send-broadcast-btn').innerHTML = '发送给所有用户';
                document.getElementById('send-broadcast-btn').disabled = false;
                document.getElementById('broadcast-result').innerHTML = `
                    <div class="alert alert-danger">
                        网络错误，请重试
                    </div>
                `;
            });
        }
        
        // 显示加载中提示
        function showLoading(elementId, message = '加载中...') {
            document.getElementById(elementId).innerHTML = `
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
