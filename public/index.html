<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Telegram Bot 多Bot管理后台</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    input, button, textarea { padding: .5em; margin: .5em 0; }
    .log { margin-top: 2em; }
    textarea { width: 100%; min-height: 50px; }
    #loginBox { margin-bottom: 2em; }
    #modal { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:999; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;}
    #modal .content { background:#fff; padding:2em 3em; border-radius: 8px; }
    .chat-id-mask { font-family:monospace; font-size:0.95em; color:#555; }
    .section { margin-bottom:2em; border-bottom:1px solid #eee; }
    .bot-list { margin: 0.5em 0; }
    .bot-list-item { margin-bottom: 0.3em; }
    .delete-btn { color: #fff; background: #e74c3c; border: none; padding: 0.2em 0.7em; border-radius: 3px; margin-left: 1em; cursor:pointer;}
    .blocked-user-item { margin-bottom: 0.2em; padding: 0.3em; border-bottom: 1px solid #eee; }
    .unblock-btn { background: #2ecc71; color: #fff; border: none; padding: 0.2em 0.7em; border-radius: 3px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>后台登录</h2>
    <input type="password" id="adminPwd" placeholder="请输入后台密码">
    <button onclick="login()">登录</button>
  </div>
  <div id="mainBox" style="display:none;">
    <h1>Telegram Bot 多Bot管理后台</h1>
    <div class="section">
      <h2>Bot配置</h2>
      <form id="botForm">
        <label>Bot名称(用户名): <input type="text" id="bot_name" required placeholder="如 mytest_bot"></label><br>
        <label>Bot Token: <input type="text" id="bot_token" required></label><br>
        <label>管理员ID(多个用英文逗号分隔): <input type="text" id="admin_ids" required></label><br>
        <button type="submit">添加/更新Bot</button>
      </form>
      <button onclick="loadBots()">刷新Bot列表</button>
      <div id="botsDiv" class="bot-list"></div>
    </div>
    <div class="section">
      <h2>客户ID列表</h2>
      <select id="botSelect" onchange="loadCustomers()"></select>
      <button onclick="loadCustomers()">刷新客户ID</button>
      <div id="customersDiv"></div>
    </div>
    <div class="section">
      <h2>已停用机器人的用户</h2>
      <select id="blockedBotSelect"></select>
      <button onclick="loadBlockedUsers()">刷新停用用户列表</button>
      <div id="blockedUsersDiv"></div>
    </div>
    <div class="section">
      <h2>发送消息（单发）</h2>
      <form id="sendForm">
        <label>选择Bot: <select id="sendBotSelect"></select></label><br>
        <label>管理员ID: <input type="text" id="sendAdminId" required></label><br>
        <label>客户ID(可多选,用逗号分隔): <input type="text" id="sendCustomerIds" required></label><br>
        <label>内容: <textarea id="sendMsg"></textarea></label><br>
        <label>上传文件:
          <input type="file" id="sendFile">
          <select id="fileType">
            <option value="">请选择类型</option>
            <option value="photo">图片</option>
            <option value="document">普通文件</option>
            <option value="video">视频</option>
            <option value="voice">语音</option>
          </select>
        </label><br>
        <button type="submit">发送</button>
      </form>
    </div>
    <div class="section">
      <h2>群发通知</h2>
      <form id="broadcastForm">
        <label>选择Bot: <select id="broadcastBotSelect"></select></label><br>
        <label>管理员ID: <input type="text" id="broadcastAdminId" required></label><br>
        <label>内容: <textarea id="broadcastMsg"></textarea></label><br>
        <label>上传文件:
          <input type="file" id="broadcastFile">
          <select id="broadcastFileType">
            <option value="">请选择类型</option>
            <option value="photo">图片</option>
            <option value="document">普通文件</option>
            <option value="video">视频</option>
            <option value="voice">语音</option>
          </select>
        </label><br>
        <button type="submit">群发</button>
      </form>
    </div>
    <div class="section">
      <h2>关键词自动回复</h2>
      <label>选择Bot:
        <select id="kwBotSelect"></select>
      </label>
      <button onclick="loadKeywords()">刷新</button>
      <form id="kwForm">
        <select id="kwType">
          <option value="equal">精准匹配</option>
          <option value="contain">模糊匹配</option>
        </select>
        <input type="text" id="kwKey" placeholder="关键词">
        <input type="text" id="kwReply" placeholder="回复内容">
        <button type="submit">添加关键词</button>
      </form>
      <div id="kwList"></div>
    </div>
    <div class="section">
      <h2>启动消息设置</h2>
      <label>选择Bot:
        <select id="startMsgBotSelect"></select>
      </label>
      <form id="startMsgForm">
        <select id="startMsgType">
          <option value="none">纯文字</option>
          <option value="photo">图片</option>
        </select>
        <label id="photoUrlLabel" style="display:inline;">
          图片链接（上传到 <a href="https://image.a5fe.com/" target="_blank">图床</a> 后粘贴链接）:
          <input type="text" id="startMsgPhotoUrl" placeholder="https://image.a5fe.com/xxx.jpg">
        </label>
        <textarea id="startMsgText" placeholder="请输入启动欢迎语"></textarea>
        <button type="submit">保存</button>
      </form>
    </div>
    <div class="section">
      <h2>API接口列表</h2>
      <div>
        <h3>所有API接口基础URL: <code id="apiBaseUrl"></code></h3>
        <p>所有POST/DELETE接口需要在请求体中包含 <code>api_pass</code> 参数进行身份验证</p>
        <table border="1" cellspacing="0" cellpadding="5" style="border-collapse: collapse; width: 100%;">
          <thead>
            <tr>
              <th>接口名称</th>
              <th>HTTP方法</th>
              <th>路径</th>
              <th>参数</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>登录验证</td>
              <td>POST</td>
              <td>/api/login</td>
              <td>{password: "密码"}</td>
              <td>验证后台密码是否正确</td>
            </tr>
            <tr>
              <td>获取Bot列表</td>
              <td>GET</td>
              <td>/api/bots</td>
              <td>无</td>
              <td>获取所有配置的Bot</td>
            </tr>
            <tr>
              <td>添加/更新Bot</td>
              <td>POST</td>
              <td>/api/bots</td>
              <td>{api_pass, bot_name, token, admins}</td>
              <td>添加或更新Bot配置</td>
            </tr>
            <tr>
              <td>删除Bot</td>
              <td>DELETE</td>
              <td>/api/bots</td>
              <td>{api_pass, bot_name}</td>
              <td>删除Bot配置</td>
            </tr>
            <tr>
              <td>获取客户列表</td>
              <td>GET</td>
              <td>/api/customers/{bot_name}</td>
              <td>无</td>
              <td>获取特定Bot的客户ID列表</td>
            </tr>
            <tr>
              <td>获取停用用户</td>
              <td>GET</td>
              <td>/api/blocked?bot_name={bot_name}</td>
              <td>无</td>
              <td>获取已停用机器人的用户</td>
            </tr>
            <tr>
              <td>添加停用用户</td>
              <td>POST</td>
              <td>/api/blocked</td>
              <td>{api_pass, bot_name, user_id}</td>
              <td>将用户标记为已停用</td>
            </tr>
            <tr>
              <td>移除停用用户</td>
              <td>DELETE</td>
              <td>/api/blocked</td>
              <td>{api_pass, bot_name, user_id}</td>
              <td>移除用户的停用标记</td>
            </tr>
            <tr>
              <td>发送消息</td>
              <td>POST</td>
              <td>/api/send</td>
              <td>{api_pass, bot_name, admin_id, customer_ids, text, fileType, fileUrl}</td>
              <td>发送消息给指定用户</td>
            </tr>
            <tr>
              <td>群发消息</td>
              <td>POST</td>
              <td>/api/broadcast</td>
              <td>{api_pass, bot_name, admin_id, text, fileType, fileUrl}</td>
              <td>群发消息给所有用户</td>
            </tr>
            <tr>
              <td>获取关键词列表</td>
              <td>GET</td>
              <td>/api/keywords?bot_name={bot_name}</td>
              <td>无</td>
              <td>获取Bot的关键词自动回复</td>
            </tr>
            <tr>
              <td>添加关键词</td>
              <td>POST</td>
              <td>/api/keywords</td>
              <td>{api_pass, bot_name, type, keyword, reply}</td>
              <td>添加自动回复关键词</td>
            </tr>
            <tr>
              <td>删除关键词</td>
              <td>DELETE</td>
              <td>/api/keywords</td>
              <td>{api_pass, bot_name, idx}</td>
              <td>删除指定位置的关键词</td>
            </tr>
            <tr>
              <td>获取启动消息</td>
              <td>GET</td>
              <td>/api/startmsg?bot_name={bot_name}</td>
              <td>无</td>
              <td>获取Bot的启动欢迎消息</td>
            </tr>
            <tr>
              <td>设置启动消息</td>
              <td>POST</td>
              <td>/api/startmsg</td>
              <td>{api_pass, bot_name, type, fileUrl, caption}</td>
              <td>设置Bot的启动欢迎消息</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="modal">
    <div class="content" id="modalContent"></div>
  </div>
  <script>
    // 配置
    const workerApiBase = "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api";
    let api_pass = localStorage.getItem('adminApiPass') || "";

    function showMain() {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainBox').style.display = '';
      document.getElementById('apiBaseUrl').textContent = workerApiBase;
      loadBots();
    }
    function showLogin() {
      document.getElementById('loginBox').style.display = '';
      document.getElementById('mainBox').style.display = 'none';
    }
    async function login() {
      const pwd = document.getElementById('adminPwd').value;
      if(!pwd) return showModal('请输入密码');
      const res = await fetch(workerApiBase + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pwd })
      });
      const data = await res.json();
      if(data.ok) {
        localStorage.setItem('adminApiPass', pwd);
        api_pass = pwd;
        showMain();
      } else {
        showModal('密码错误');
      }
    }
    function showModal(msg) {
      document.getElementById('modalContent').innerText = msg;
      document.getElementById('modal').style.display = 'flex';
    }
    document.getElementById('modal').onclick = function(){this.style.display='none'};

    let botsCache = {};
    async function loadBots() {
      const res = await fetch(workerApiBase + "/bots");
      const bots = await res.json();
      botsCache = bots;
      let html = '<ul>';
      for(const k in bots){
        html += `<li class="bot-list-item"><b>${k}</b> Token: ${bots[k].token.slice(0,8)}... 管理员: ${bots[k].admins.join(",")}
         <button class="delete-btn" onclick="deleteBot('${k}')">删除</button></li>`;
      }
      html += '</ul>';
      document.getElementById('botsDiv').innerHTML = html;
      let options = '';
      for(const k in bots) options += `<option value="${k}">${k}</option>`;
      document.getElementById('botSelect').innerHTML = options;
      document.getElementById('sendBotSelect').innerHTML = options;
      document.getElementById('broadcastBotSelect').innerHTML = options;
      document.getElementById('kwBotSelect').innerHTML = options;
      document.getElementById('startMsgBotSelect').innerHTML = options;
      document.getElementById('blockedBotSelect').innerHTML = options;
      loadStartMsg();
      loadBlockedUsers();
    }
    async function deleteBot(bot_name) {
      if(!confirm('确定要删除Bot：'+bot_name+'？')) return;
      const res = await fetch(workerApiBase + "/bots", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('Bot已删除!');
        loadBots();
      } else {
        showModal('删除失败:'+d.error);
      }
    }
    document.getElementById('botForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('bot_name').value;
      const token = document.getElementById('bot_token').value;
      const admins = document.getElementById('admin_ids').value.split(",").map(v=>v.trim()).filter(Boolean);
      const res = await fetch(workerApiBase + "/bots", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,token,admins})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('Bot配置成功!');
        loadBots();
      } else {
        showModal('配置失败:'+d.error);
      }
    };

    async function loadCustomers() {
      const bot_name = document.getElementById('botSelect').value;
      const res = await fetch(workerApiBase + `/customers/${encodeURIComponent(bot_name)}`);
      const list = await res.json();
      let html = '<ul>';
      for(const id of list){
        html += `<li>${id} <button onclick="document.getElementById('sendCustomerIds').value='${id}';">填入</button></li>`;
      }
      html += '</ul>';
      document.getElementById('customersDiv').innerHTML = html;
    }

    // 加载已停用机器人的用户列表
    async function loadBlockedUsers() {
      const bot_name = document.getElementById('blockedBotSelect').value;
      if (!bot_name) return;
      
      const res = await fetch(workerApiBase + `/blocked?bot_name=${encodeURIComponent(bot_name)}`);
      const blockedUsers = await res.json();
      
      if (!blockedUsers || blockedUsers.length === 0) {
        document.getElementById('blockedUsersDiv').innerHTML = '<p>没有已停用机器人的用户</p>';
        return;
      }
      
      let html = '<ul>';
      for (const user_id of blockedUsers) {
        html += `<li class="blocked-user-item">
          用户ID: ${user_id}
          <button class="unblock-btn" onclick="unblockUser('${bot_name}', '${user_id}')">移除停用标记</button>
        </li>`;
      }
      html += '</ul>';
      document.getElementById('blockedUsersDiv').innerHTML = html;
    }

    // 移除用户的停用标记
    async function unblockUser(bot_name, user_id) {
      if (!confirm(`确定要移除用户 ${user_id} 的停用标记吗？`)) return;
      
      const res = await fetch(workerApiBase + "/blocked", {
        method: "DELETE",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({api_pass, bot_name, user_id})
      });
      
      const data = await res.json();
      if (data.ok) {
        showModal(`用户 ${user_id} 的停用标记已移除`);
        loadBlockedUsers();
      } else {
        showModal('操作失败: ' + (data.error || '未知错误'));
      }
    }

    document.getElementById('sendForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('sendBotSelect').value;
      const admin_id = document.getElementById('sendAdminId').value.trim();
      const customer_ids = document.getElementById('sendCustomerIds').value.split(",").map(v=>v.trim()).filter(Boolean);
      const text = document.getElementById('sendMsg').value;
      const fileInput = document.getElementById('sendFile');
      const fileType = document.getElementById('fileType').value;
      let fileUrl = "";
      const botsRes = await fetch(workerApiBase + "/bots");
      const bots = await botsRes.json();
      const botToken = bots[bot_name].token;

      if(fileInput.files.length && fileType){
        // 这里依然调用Telegram上传接口（sendPhoto/sendDocument/sendVideo/sendVoice）
        const form = new FormData();
        form.append(fileType, fileInput.files[0]);
        form.append("chat_id", admin_id);
        const resUpload = await fetch(`https://api.telegram.org/bot${botToken}/${fileType === "photo" ? "sendPhoto" : fileType === "video" ? "sendVideo" : fileType === "voice" ? "sendVoice" : "sendDocument"}`, {method:"POST", body: form});
        const data = await resUpload.json();
        if(fileType === "photo" && data && data.result) fileUrl = data.result.photo[data.result.photo.length-1].file_id;
        else if(fileType === "document" && data && data.result) fileUrl = data.result.document.file_id;
        else if(fileType === "video" && data && data.result) fileUrl = data.result.video.file_id;
        else if(fileType === "voice" && data && data.result) fileUrl = data.result.voice.file_id;
        if(!fileUrl) {
          showModal('文件上传失败');
          return;
        }
      }

      const res = await fetch(workerApiBase + "/send", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,admin_id,customer_ids,text,fileType,fileUrl})
      });
      const d = await res.json();
      if(d.ok) showModal('消息已发送!');
      else showModal('发送失败:'+(d.error||JSON.stringify(d)));
    };

    // 群发通知
    document.getElementById('broadcastForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('broadcastBotSelect').value;
      const admin_id = document.getElementById('broadcastAdminId').value.trim();
      const text = document.getElementById('broadcastMsg').value;
      const fileInput = document.getElementById('broadcastFile');
      const fileType = document.getElementById('broadcastFileType').value;
      let fileUrl = "";
      const botsRes = await fetch(workerApiBase + "/bots");
      const bots = await botsRes.json();
      const botToken = bots[bot_name].token;

      if(fileInput.files.length && fileType){
        const form = new FormData();
        form.append(fileType, fileInput.files[0]);
        form.append("chat_id", admin_id);
        const resUpload = await fetch(`https://api.telegram.org/bot${botToken}/${fileType === "photo" ? "sendPhoto" : fileType === "video" ? "sendVideo" : fileType === "voice" ? "sendVoice" : "sendDocument"}`, {method:"POST", body: form});
        const data = await resUpload.json();
        if(fileType === "photo" && data && data.result) fileUrl = data.result.photo[data.result.photo.length-1].file_id;
        else if(fileType === "document" && data && data.result) fileUrl = data.result.document.file_id;
        else if(fileType === "video" && data && data.result) fileUrl = data.result.video.file_id;
        else if(fileType === "voice" && data && data.result) fileUrl = data.result.voice.file_id;
        if(!fileUrl) {
          showModal('文件上传失败');
          return;
        }
      }

      const res = await fetch(workerApiBase + "/broadcast", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,admin_id,text,fileType,fileUrl})
      });
      const d = await res.json();
      if(d.ok) showModal('群发成功！本次发送：'+d.count+'人');
      else showModal('群发失败:'+(d.error||JSON.stringify(d)));
    };

    // 关键词自动回复
    async function loadKeywords() {
      const bot_name = document.getElementById('kwBotSelect').value;
      const res = await fetch(workerApiBase + `/keywords?bot_name=${encodeURIComponent(bot_name)}`);
      const keywords = await res.json();
      let html = '<ul>';
      for(const [i, kw] of keywords.entries()) {
        html += `<li>[${kw.type==='equal'?'精准':'模糊'}] <b>${kw.keyword}</b> → ${kw.reply}
          <button onclick="deleteKeyword(${i})">删除</button></li>`;
      }
      html += '</ul>';
      document.getElementById('kwList').innerHTML = html;
    }
    document.getElementById('kwForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('kwBotSelect').value;
      const type = document.getElementById('kwType').value;
      const keyword = document.getElementById('kwKey').value.trim();
      const reply = document.getElementById('kwReply').value.trim();
      if(!keyword||!reply) return showModal('关键词和回复内容必填');
      const res = await fetch(workerApiBase + "/keywords", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,type,keyword,reply})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('添加成功');
        loadKeywords();
      } else {
        showModal('添加失败:'+d.error);
      }
    };
    async function deleteKeyword(idx) {
      const bot_name = document.getElementById('kwBotSelect').value;
      if(!confirm('确定删除该关键词？')) return;
      await fetch(workerApiBase + "/keywords", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,idx})
      });
      loadKeywords();
    }

    // 启动消息管理
    async function loadStartMsg() {
      const bot_name = document.getElementById('startMsgBotSelect').value;
      if(!bot_name) return;
      const res = await fetch(workerApiBase + `/startmsg?bot_name=${encodeURIComponent(bot_name)}`);
      const d = await res.json();
      document.getElementById('startMsgType').value = d.type || "none";
      document.getElementById('startMsgPhotoUrl').value = d.fileUrl || "";
      document.getElementById('startMsgText').value = d.caption || "";
    }
    document.getElementById('startMsgBotSelect').onchange = loadStartMsg;
    document.getElementById('startMsgForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('startMsgBotSelect').value;
      const type = document.getElementById('startMsgType').value;
      const caption = document.getElementById('startMsgText').value;
      const fileUrl = document.getElementById('startMsgPhotoUrl').value.trim();
      if(type === "photo" && !fileUrl) {
        showModal('请粘贴经过图床上传后的图片链接');
        return;
      }
      const res = await fetch(workerApiBase + "/startmsg", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,type,fileUrl,caption})
      });
      const d = await res.json();
      if(d.ok) showModal('启动消息已保存');
      else showModal('保存失败:'+d.error);
    };

    // 已停用用户管理
    document.getElementById('blockedBotSelect').onchange = loadBlockedUsers;

    window.onload = function(){
      if(api_pass) showMain();
      else showLogin();
    }
  </script>
</body>
</html>
