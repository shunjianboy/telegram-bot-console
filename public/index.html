<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Telegram Bot 多Bot管理后台</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    input, button, textarea { padding: .5em; margin: .5em 0; }
    .log { margin-top: 2em; }
    textarea { width: 100%; min-height: 50px; }
    #loginBox { margin-bottom: 2em; }
    #modal { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:999; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;}
    #modal .content { background:#fff; padding:2em 3em; border-radius: 8px; }
    .chat-id-mask { font-family:monospace; font-size:0.95em; color:#555; }
    .section { margin-bottom:2em; border-bottom:1px solid #eee; }
    .bot-list { margin: 0.5em 0; }
    .bot-list-item { margin-bottom: 0.3em; }
    .delete-btn { color: #fff; background: #e74c3c; border: none; padding: 0.2em 0.7em; border-radius: 3px; margin-left: 1em; cursor:pointer;}
    .blocked-user-item { display: flex; align-items: center; margin-bottom: 5px; }
    .unblock-btn { color: #fff; background: #3498db; border: none; padding: 0.2em 0.7em; border-radius: 3px; margin-left: 1em; cursor:pointer;}
    #apiDocs { background: #f8f9fa; padding: 1em; border-radius: 5px; border: 1px solid #e9ecef; }
    .api-endpoint { margin-bottom: 1em; }
    .api-method { display: inline-block; padding: 2px 6px; border-radius: 3px; color: white; font-weight: bold; margin-right: 8px; }
    .get { background-color: #61affe; }
    .post { background-color: #49cc90; }
    .delete { background-color: #f93e3e; }
    pre { background: #f1f1f1; padding: 10px; border-radius: 3px; overflow-x: auto; }
    code { font-family: monospace; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>后台登录</h2>
    <input type="password" id="adminPwd" placeholder="请输入后台密码">
    <button onclick="login()">登录</button>
  </div>
  <div id="mainBox" style="display:none;">
    <h1>Telegram Bot 多Bot管理后台</h1>
    <div class="section">
      <h2>Bot配置</h2>
      <form id="botForm">
        <label>Bot名称(用户名): <input type="text" id="bot_name" required placeholder="如 mytest_bot"></label><br>
        <label>Bot Token: <input type="text" id="bot_token" required></label><br>
        <label>管理员ID(多个用英文逗号分隔): <input type="text" id="admin_ids" required></label><br>
        <button type="submit">添加/更新Bot</button>
      </form>
      <button onclick="loadBots()">刷新Bot列表</button>
      <div id="botsDiv" class="bot-list"></div>
    </div>
    <div class="section">
      <h2>客户ID列表</h2>
      <select id="botSelect" onchange="loadCustomers()"></select>
      <button onclick="loadCustomers()">刷新客户ID</button>
      <div id="customersDiv"></div>
    </div>
    <div class="section">
      <h2>发送消息（单发）</h2>
      <form id="sendForm">
        <label>选择Bot: <select id="sendBotSelect"></select></label><br>
        <label>管理员ID: <input type="text" id="sendAdminId" required></label><br>
        <label>客户ID(可多选,用逗号分隔): <input type="text" id="sendCustomerIds" required></label><br>
        <label>内容: <textarea id="sendMsg"></textarea></label><br>
        <label>上传文件:
          <input type="file" id="sendFile">
          <select id="fileType">
            <option value="">请选择类型</option>
            <option value="photo">图片</option>
            <option value="document">普通文件</option>
          </select>
        </label><br>
        <button type="submit">发送</button>
      </form>
    </div>
    <div class="section">
      <h2>群发通知</h2>
      <form id="broadcastForm">
        <label>选择Bot: <select id="broadcastBotSelect"></select></label><br>
        <label>管理员ID: <input type="text" id="broadcastAdminId" required></label><br>
        <label>内容: <textarea id="broadcastMsg"></textarea></label><br>
        <label>上传文件:
          <input type="file" id="broadcastFile">
          <select id="broadcastFileType">
            <option value="">请选择类型</option>
            <option value="photo">图片</option>
            <option value="document">普通文件</option>
          </select>
        </label><br>
        <button type="submit">群发</button>
      </form>
    </div>
    <div class="section">
      <h2>关键词自动回复</h2>
      <label>选择Bot:
        <select id="kwBotSelect"></select>
      </label>
      <button onclick="loadKeywords()">刷新</button>
      <form id="kwForm">
        <select id="kwType">
          <option value="equal">精准匹配</option>
          <option value="contain">模糊匹配</option>
        </select>
        <input type="text" id="kwKey" placeholder="关键词">
        <input type="text" id="kwReply" placeholder="回复内容">
        <button type="submit">添加关键词</button>
      </form>
      <div id="kwList"></div>
    </div>
    <div class="section">
      <h2>启动消息设置</h2>
      <label>选择Bot:
        <select id="startMsgBotSelect"></select>
      </label>
      <form id="startMsgForm">
        <select id="startMsgType">
          <option value="none">纯文字</option>
          <option value="photo">图片</option>
        </select>
        <label id="photoUrlLabel" style="display:inline;">
          图片链接（上传到 <a href="https://image.a5fe.com/" target="_blank">图床</a> 后粘贴链接）:
          <input type="text" id="startMsgPhotoUrl" placeholder="https://image.a5fe.com/xxx.jpg">
        </label>
        <textarea id="startMsgText" placeholder="请输入启动欢迎语"></textarea>
        <button type="submit">保存</button>
      </form>
    </div>
    
    <!-- 添加已停用用户管理 -->
    <div class="section">
      <h2>已停用用户管理</h2>
      <label>选择Bot:
        <select id="blockedBotSelect"></select>
      </label>
      <button onclick="loadBlockedUsers()">刷新</button>
      <form id="blockUserForm">
        <input type="text" id="blockUserId" placeholder="用户ID">
        <button type="submit">添加到停用列表</button>
      </form>
      <div id="blockedUsersList"></div>
    </div>
    
    <!-- 添加API文档部分 -->
    <div class="section">
      <h2>API文档</h2>
      <div id="apiDocs">
        <p>所有API请求需要包含<code>api_key</code>参数进行身份验证，可通过以下方式获取API密钥：</p>
        <button onclick="generateApiKey()">生成API密钥</button>
        <div id="apiKeyDisplay"></div>
        
        <h3>可用API端点：</h3>
        <div class="api-endpoint">
          <div><span class="api-method get">GET</span> <code>/api/v1/bots</code> - 获取所有Bot列表</div>
          <pre>curl -X GET "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/bots?api_key=YOUR_API_KEY"</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method post">POST</span> <code>/api/v1/bots</code> - 添加/更新Bot</div>
          <pre>curl -X POST "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/bots" \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "bot_name": "your_bot_name",
    "token": "BOT_TOKEN",
    "admins": ["123456789", "987654321"]
  }'</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method delete">DELETE</span> <code>/api/v1/bots/{bot_name}</code> - 删除Bot</div>
          <pre>curl -X DELETE "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/bots/your_bot_name?api_key=YOUR_API_KEY"</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method get">GET</span> <code>/api/v1/customers/{bot_name}</code> - 获取客户ID列表</div>
          <pre>curl -X GET "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/customers/your_bot_name?api_key=YOUR_API_KEY"</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method post">POST</span> <code>/api/v1/send</code> - 发送消息</div>
          <pre>curl -X POST "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/send" \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "bot_name": "your_bot_name",
    "admin_id": "123456789",
    "customer_ids": ["987654321"],
    "text": "消息内容"
  }'</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method post">POST</span> <code>/api/v1/broadcast</code> - 群发消息</div>
          <pre>curl -X POST "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/broadcast" \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "bot_name": "your_bot_name",
    "admin_id": "123456789",
    "text": "群发消息内容"
  }'</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method get">GET</span> <code>/api/v1/blocked/{bot_name}</code> - 获取已停用用户列表</div>
          <pre>curl -X GET "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/blocked/your_bot_name?api_key=YOUR_API_KEY"</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method post">POST</span> <code>/api/v1/blocked</code> - 添加停用用户</div>
          <pre>curl -X POST "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/blocked" \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "bot_name": "your_bot_name",
    "user_id": "123456789"
  }'</pre>
        </div>
        
        <div class="api-endpoint">
          <div><span class="api-method delete">DELETE</span> <code>/api/v1/blocked</code> - 移除停用用户</div>
          <pre>curl -X DELETE "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api/v1/blocked" \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "bot_name": "your_bot_name",
    "user_id": "123456789"
  }'</pre>
        </div>
      </div>
    </div>
  </div>
  <div id="modal">
    <div class="content" id="modalContent"></div>
  </div>
  <script>
    // 配置
    const workerApiBase = "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api";
    let api_pass = localStorage.getItem('adminApiPass') || "";
    let api_key = localStorage.getItem('adminApiKey') || "";

    function showMain() {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainBox').style.display = '';
      loadBots();
    }
    function showLogin() {
      document.getElementById('loginBox').style.display = '';
      document.getElementById('mainBox').style.display = 'none';
    }
    async function login() {
      const pwd = document.getElementById('adminPwd').value;
      if(!pwd) return showModal('请输入密码');
      const res = await fetch(workerApiBase + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pwd })
      });
      const data = await res.json();
      if(data.ok) {
        localStorage.setItem('adminApiPass', pwd);
        api_pass = pwd;
        showMain();
      } else {
        showModal('密码错误');
      }
    }
    function showModal(msg) {
      document.getElementById('modalContent').innerText = msg;
      document.getElementById('modal').style.display = 'flex';
    }
    document.getElementById('modal').onclick = function(){this.style.display='none'};

    let botsCache = {};
    async function loadBots() {
      const res = await fetch(workerApiBase + "/bots");
      const bots = await res.json();
      botsCache = bots;
      let html = '<ul>';
      for(const k in bots){
        html += `<li class="bot-list-item"><b>${k}</b> Token: ${bots[k].token.slice(0,8)}... 管理员: ${bots[k].admins.join(",")}
         <button class="delete-btn" onclick="deleteBot('${k}')">删除</button></li>`;
      }
      html += '</ul>';
      document.getElementById('botsDiv').innerHTML = html;
      let options = '';
      for(const k in bots) options += `<option value="${k}">${k}</option>`;
      document.getElementById('botSelect').innerHTML = options;
      document.getElementById('sendBotSelect').innerHTML = options;
      document.getElementById('broadcastBotSelect').innerHTML = options;
      document.getElementById('kwBotSelect').innerHTML = options;
      document.getElementById('startMsgBotSelect').innerHTML = options;
      document.getElementById('blockedBotSelect').innerHTML = options;
      loadStartMsg();
      loadBlockedUsers();
    }
    async function deleteBot(bot_name) {
      if(!confirm('确定要删除Bot：'+bot_name+'？')) return;
      const res = await fetch(workerApiBase + "/bots", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('Bot已删除!');
        loadBots();
      } else {
        showModal('删除失败:'+d.error);
      }
    }
    document.getElementById('botForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('bot_name').value;
      const token = document.getElementById('bot_token').value;
      const admins = document.getElementById('admin_ids').value.split(",").map(v=>v.trim()).filter(Boolean);
      const res = await fetch(workerApiBase + "/bots", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,token,admins})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('Bot配置成功!');
        loadBots();
      } else {
        showModal('配置失败:'+d.error);
      }
    };

    async function loadCustomers() {
      const bot_name = document.getElementById('botSelect').value;
      const res = await fetch(workerApiBase + `/customers/${encodeURIComponent(bot_name)}`);
      const list = await res.json();
      let html = '<ul>';
      for(const id of list){
        html += `<li>${id} <button onclick="document.getElementById('sendCustomerIds').value='${id}';">填入</button></li>`;
      }
      html += '</ul>';
      document.getElementById('customersDiv').innerHTML = html;
    }

    document.getElementById('sendForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('sendBotSelect').value;
      const admin_id = document.getElementById('sendAdminId').value.trim();
      const customer_ids = document.getElementById('sendCustomerIds').value.split(",").map(v=>v.trim()).filter(Boolean);
      const text = document.getElementById('sendMsg').value;
      const fileInput = document.getElementById('sendFile');
      const fileType = document.getElementById('fileType').value;
      let fileUrl = "";
      const botsRes = await fetch(workerApiBase + "/bots");
      const bots = await botsRes.json();
      const botToken = bots[bot_name].token;

      if(fileInput.files.length && fileType){
        // 这里依然调用Telegram上传接口（sendPhoto/sendDocument）
        const form = new FormData();
        if(fileType === "photo") form.append("photo", fileInput.files[0]);
        else form.append("document", fileInput.files[0]);
        form.append("chat_id", admin_id);
        const resUpload = await fetch(`https://api.telegram.org/bot${botToken}/${fileType === "photo" ? "sendPhoto" : "sendDocument"}`, {method:"POST", body: form});
        const data = await resUpload.json();
        if(fileType === "photo" && data && data.result) fileUrl = data.result.photo[data.result.photo.length-1].file_id;
        if(fileType === "document" && data && data.result) fileUrl = data.result.document.file_id;
        if(!fileUrl) {
          showModal('文件上传失败');
          return;
        }
      }

      const res = await fetch(workerApiBase + "/send", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,admin_id,customer_ids,text,fileType,fileUrl})
      });
      const d = await res.json();
      if(d.ok) showModal('消息已发送!');
      else showModal('发送失败:'+(d.error||JSON.stringify(d)));
    };

    // 群发通知
    document.getElementById('broadcastForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('broadcastBotSelect').value;
      const admin_id = document.getElementById('broadcastAdminId').value.trim();
      const text = document.getElementById('broadcastMsg').value;
      const fileInput = document.getElementById('broadcastFile');
      const fileType = document.getElementById('broadcastFileType').value;
      let fileUrl = "";
      const botsRes = await fetch(workerApiBase + "/bots");
      const bots = await botsRes.json();
      const botToken = bots[bot_name].token;

      if(fileInput.files.length && fileType){
        const form = new FormData();
        if(fileType === "photo") form.append("photo", fileInput.files[0]);
        else form.append("document", fileInput.files[0]);
        form.append("chat_id", admin_id);
        const resUpload = await fetch(`https://api.telegram.org/bot${botToken}/${fileType === "photo" ? "sendPhoto" : "sendDocument"}`, {method:"POST", body: form});
        const data = await resUpload.json();
        if(fileType === "photo" && data && data.result) fileUrl = data.result.photo[data.result.photo.length-1].file_id;
        if(fileType === "document" && data && data.result) fileUrl = data.result.document.file_id;
        if(!fileUrl) {
          showModal('文件上传失败');
          return;
        }
      }

      const res = await fetch(workerApiBase + "/broadcast", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,admin_id,text,fileType,fileUrl})
      });
      const d = await res.json();
      if(d.ok) showModal('群发成功！本次发送：'+d.count+'人');
      else showModal('群发失败:'+(d.error||JSON.stringify(d)));
    };

    // 关键词自动回复
    async function loadKeywords() {
      const bot_name = document.getElementById('kwBotSelect').value;
      const res = await fetch(workerApiBase + `/keywords?bot_name=${encodeURIComponent(bot_name)}`);
      const keywords = await res.json();
      let html = '<ul>';
      for(const [i, kw] of keywords.entries()) {
        html += `<li>[${kw.type==='equal'?'精准':'模糊'}] <b>${kw.keyword}</b> → ${kw.reply}
          <button onclick="deleteKeyword(${i})">删除</button></li>`;
      }
      html += '</ul>';
      document.getElementById('kwList').innerHTML = html;
    }
    document.getElementById('kwForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('kwBotSelect').value;
      const type = document.getElementById('kwType').value;
      const keyword = document.getElementById('kwKey').value.trim();
      const reply = document.getElementById('kwReply').value.trim();
      if(!keyword||!reply) return showModal('关键词和回复内容必填');
      const res = await fetch(workerApiBase + "/keywords", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,type,keyword,reply})
      });
      const d = await res.json();
      if(d.ok) {
        showModal('添加成功');
        loadKeywords();
      } else {
        showModal('添加失败:'+d.error);
      }
    };
    async function deleteKeyword(idx) {
      const bot_name = document.getElementById('kwBotSelect').value;
      if(!confirm('确定删除该关键词？')) return;
      await fetch(workerApiBase + "/keywords", {
        method:"DELETE",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,idx})
      });
      loadKeywords();
    }

    // 启动消息管理
    async function loadStartMsg() {
      const bot_name = document.getElementById('startMsgBotSelect').value;
      if(!bot_name) return;
      const res = await fetch(workerApiBase + `/startmsg?bot_name=${encodeURIComponent(bot_name)}`);
      const d = await res.json();
      document.getElementById('startMsgType').value = d.type || "none";
      document.getElementById('startMsgPhotoUrl').value = d.fileUrl || "";
      document.getElementById('startMsgText').value = d.caption || "";
    }
    document.getElementById('startMsgBotSelect').onchange = loadStartMsg;
    document.getElementById('startMsgForm').onsubmit = async (e)=>{
      e.preventDefault();
      const bot_name = document.getElementById('startMsgBotSelect').value;
      const type = document.getElementById('startMsgType').value;
      const caption = document.getElementById('startMsgText').value;
      const fileUrl = document.getElementById('startMsgPhotoUrl').value.trim();
      if(type === "photo" && !fileUrl) {
        showModal('请粘贴经过图床上传后的图片链接');
        return;
      }
      const res = await fetch(workerApiBase + "/startmsg", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({api_pass,bot_name,type,fileUrl,caption})
      });
      const d = await res.json();
      if(d.ok) showModal('启动消息已保存');
      else showModal('保存失败:'+d.error);
    };
    
    // 已停用用户管理
    async function loadBlockedUsers() {
      const bot_name = document.getElementById('blockedBotSelect').value;
      if(!bot_name) return;
      
      const res = await fetch(workerApiBase + `/blocked?bot_name=${encodeURIComponent(bot_name)}`);
      const users = await res.json();
      
      if(users && users.length > 0) {
        let html = '<h3>已停用机器人的用户列表</h3><ul>';
        for(const user_id of users) {
          html += `<li class="blocked-user-item">
            <span>用户ID: ${user_id}</span>
            <button class="unblock-btn" onclick="unblockUser('${bot_name}', '${user_id}')">解除停用</button>
          </li>`;
        }
        html += '</ul>';
        document.getElementById('blockedUsersList').innerHTML = html;
      } else {
        document.getElementById('blockedUsersList').innerHTML = '<p>没有已停用的用户</p>';
      }
    }
    
    document.getElementById('blockUserForm').onsubmit = async (e) => {
      e.preventDefault();
      const bot_name = document.getElementById('blockedBotSelect').value;
      const user_id = document.getElementById('blockUserId').value.trim();
      
      if(!bot_name || !user_id) {
        showModal('请选择Bot并输入用户ID');
        return;
      }
      
      const res = await fetch(workerApiBase + "/blocked", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({api_pass, bot_name, user_id})
      });
      
      const data = await res.json();
      if(data.ok) {
        showModal('用户已添加到停用列表');
        document.getElementById('blockUserId').value = '';
        loadBlockedUsers();
      } else {
        showModal('添加失败: ' + (data.error || '未知错误'));
      }
    };
    
    async function unblockUser(bot_name, user_id) {
      if(!confirm(`确定要解除用户 ${user_id} 的停用状态吗？`)) return;
      
      const res = await fetch(workerApiBase + "/blocked", {
        method: "DELETE",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({api_pass, bot_name, user_id})
      });
      
      const data = await res.json();
      if(data.ok) {
        showModal('用户已解除停用');
        loadBlockedUsers();
      } else {
        showModal('解除失败: ' + (data.error || '未知错误'));
      }
    }
    
    // API密钥管理
    async function generateApiKey() {
      const res = await fetch(workerApiBase + "/apikey", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({api_pass})
      });
      
      const data = await res.json();
      if(data.ok && data.api_key) {
        api_key = data.api_key;
        localStorage.setItem('adminApiKey', api_key);
        document.getElementById('apiKeyDisplay').innerHTML = `<p>您的API密钥: <code>${api_key}</code></p>
          <p>请妥善保管此密钥，它可以访问所有API功能。</p>`;
      } else {
        showModal('生成API密钥失败: ' + (data.error || '未知错误'));
      }
    }

    window.onload = function(){
      if(api_pass) showMain();
      else showLogin();
      
      if(api_key) {
        document.getElementById('apiKeyDisplay').innerHTML = `<p>您的API密钥: <code>${api_key}</code></p>
          <p>请妥善保管此密钥，它可以访问所有API功能。</p>`;
      }
    }
  </script>
</body>
</html>
