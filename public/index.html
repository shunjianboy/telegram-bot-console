<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Telegram Bot 管理后台</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    input, button { padding: .5em; margin: .5em 0; }
    .log { margin-top: 2em; }
    textarea { width: 100%; min-height: 50px; }
    #loginBox { margin-bottom: 2em; }
    #modal { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:999; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;}
    #modal .content { background:#fff; padding:2em 3em; border-radius: 8px; }
    .chat-id-mask { font-family:monospace; font-size:0.95em; color:#555; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>后台登录</h2>
    <input type="password" id="adminPwd" placeholder="请输入后台密码">
    <button onclick="login()">登录</button>
  </div>
  <div id="mainBox" style="display:none;">
    <h1>Telegram Bot 管理后台</h1>
    <h2>发送消息</h2>
    <form id="sendForm">
      <label>Chat ID:
        <input type="text" id="chat_id" required>
      </label><br>
      <label>消息内容:
        <textarea id="msg" required></textarea>
      </label><br>
      <button type="submit">发送</button>
    </form>
    <h2>最近聊天记录</h2>
    <button onclick="loadLogs()">刷新聊天记录</button>
    <div id="logs" class="log"></div>
  </div>

  <div id="modal">
    <div class="content" id="modalContent"></div>
  </div>

  <script>
    // 配置
    const ADMIN_PASS = '你的自定义后台密码'; // 请修改为强密码！
    const workerApiBase = "https://telegram-bot-api.shunjianboy-e0e.workers.dev/api";

    // 登录功能
    if(localStorage.getItem('isAdmin')) {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('mainBox').style.display = '';
    }
    function login() {
      if(document.getElementById('adminPwd').value === ADMIN_PASS) {
        localStorage.setItem('isAdmin', '1');
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('mainBox').style.display = '';
      } else {
        showModal('密码错误');
      }
    }

    // 弹窗
    function showModal(msg) {
      document.getElementById('modalContent').innerText = msg;
      document.getElementById('modal').style.display = 'flex';
    }
    document.getElementById('modal').onclick = function(){this.style.display='none'};

    // 发送消息
    document.getElementById('sendForm').onsubmit = async (e) => {
      e.preventDefault();
      const chat_id = document.getElementById('chat_id').value;
      const text = document.getElementById('msg').value;
      if(!chat_id || !text) {
        showModal('Chat ID 和消息内容不能为空！');
        return;
      }
      try {
        const res = await fetch(workerApiBase + '/send', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ chat_id, text })
        });
        let result;
        try { result = await res.json(); } catch(e) { result = await res.text(); }
        if(result.ok) {
          showModal('发送成功！');
        } else {
          showModal('发送失败：' + JSON.stringify(result));
        }
      } catch (err) {
        showModal('请求失败：' + err);
      }
    };

    // 聊天记录遮掩chat_id
    function maskChatId(chat_id) {
      if(!chat_id || chat_id.length < 8) return chat_id;
      return chat_id.slice(0,4) + '****' + chat_id.slice(-4);
    }

    // 获取聊天记录
    async function loadLogs() {
      const logsDiv = document.getElementById('logs');
      logsDiv.innerHTML = "加载中...";
      try {
        const res = await fetch(workerApiBase + '/logs');
        const logs = await res.json();
        let html = '<ol>';
        for (const log of logs) {
          html += `<li>
            <span class="chat-id-mask">${maskChatId(log.chat_id)}</span>
            : ${log.message}
            <small style="color:#888">${new Date(log.created_at).toLocaleString()}</small>
            <button onclick="document.getElementById('chat_id').value='${log.chat_id}';">填入ChatID</button>
          </li>`;
        }
        html += '</ol>';
        logsDiv.innerHTML = html;
      } catch (err) {
        logsDiv.innerHTML = '获取聊天记录失败：' + err;
      }
    }

    // 页面加载自动加载聊天记录
    if(localStorage.getItem('isAdmin')) loadLogs();
  </script>
</body>
</html>
