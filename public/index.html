<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Bot 多Bot管理后台</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- 登录页面 -->
  <div id="loginBox" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <i class="fas fa-robot"></i>
        <h2>Telegram Bot 管理后台</h2>
      </div>
      <div class="login-body">
        <div class="input-group">
          <label for="adminPwd">管理员密码</label>
          <input type="password" id="adminPwd" placeholder="请输入后台密码">
        </div>
        <button class="btn btn-primary login-btn" onclick="login()">
          <i class="fas fa-sign-in-alt"></i> 登录
        </button>
      </div>
    </div>
  </div>

  <!-- 主要内容区 -->
  <div id="mainBox" class="main-container">
    <header class="main-header">
      <h1><i class="fas fa-robot"></i> Telegram Bot 多Bot管理后台</h1>
    </header>

    <div class="sidebar">
      <nav class="nav-menu">
        <ul>
          <li><a href="#botConfig" class="active"><i class="fas fa-cog"></i> Bot配置</a></li>
          <li><a href="#customerList"><i class="fas fa-users"></i> 客户ID列表</a></li>
          <li><a href="#blockedUsers"><i class="fas fa-user-slash"></i> 已停用用户</a></li>
		  <li><a href="#blacklist"><i class="fas fa-ban"></i> 黑名单管理</a></li>
          <li><a href="#sendMessage"><i class="fas fa-paper-plane"></i> 发送消息</a></li>
          <li><a href="#broadcast"><i class="fas fa-broadcast-tower"></i> 群发通知</a></li>
          <li><a href="#keywords"><i class="fas fa-reply-all"></i> 关键词回复</a></li>
          <li><a href="#startMsg"><i class="fas fa-play-circle"></i> 启动消息</a></li>
          <li><a href="#apiList"><i class="fas fa-code"></i> API接口</a></li>
        </ul>
      </nav>
    </div>

    <main class="content">
      <!-- Bot配置 -->
      <section id="botConfig" class="card">
        <div class="card-header">
          <h2><i class="fas fa-cog"></i> Bot配置</h2>
        </div>
        <div class="card-body">
          <form id="botForm" class="form-grid">
            <div class="input-group">
              <label for="bot_name">Bot名称(用户名)</label>
              <input type="text" id="bot_name" required placeholder="如 mytest_bot">
            </div>
            <div class="input-group">
              <label for="bot_token">Bot Token</label>
              <input type="text" id="bot_token" required>
            </div>
            <div class="input-group">
              <label for="admin_ids">管理员ID(多个用英文逗号分隔)</label>
              <input type="text" id="admin_ids" required>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 添加/更新Bot</button>
          </form>
          <div class="action-bar">
            <button class="btn btn-secondary" onclick="loadBots()">
              <i class="fas fa-sync"></i> 刷新Bot列表
            </button>
          </div>
          <div id="botsDiv" class="bot-list"></div>
        </div>
      </section>

      <!-- 客户ID列表 -->
      <section id="customerList" class="card">
        <div class="card-header">
          <h2><i class="fas fa-users"></i> 客户ID列表</h2>
        </div>
        <div class="card-body">
          <div class="action-bar">
            <select id="botSelect" class="select-styled"></select>
            <button class="btn btn-secondary" onclick="loadCustomers()">
              <i class="fas fa-sync"></i> 刷新客户ID
            </button>
          </div>
          <div id="customersDiv" class="customer-list"></div>
        </div>
      </section>

      <!-- 已停用机器人的用户 -->
      <section id="blockedUsers" class="card">
        <div class="card-header">
          <h2><i class="fas fa-user-slash"></i> 已停用机器人的用户</h2>
        </div>
        <div class="card-body">
          <div class="action-bar">
            <select id="blockedBotSelect" class="select-styled"></select>
            <button class="btn btn-secondary" onclick="loadBlockedUsers()">
              <i class="fas fa-sync"></i> 刷新停用用户列表
            </button>
          </div>
          <div id="blockedUsersDiv" class="blocked-users-list"></div>
        </div>
      </section>
	  
	  <!-- 黑名单管理 -->
		<section id="blacklist" class="card">
		  <div class="card-header">
			<h2><i class="fas fa-ban"></i> 黑名单管理</h2>
			<p class="hint-text">被拉黑的用户消息将不会转发给管理员，也不会收到任何回复</p>
		  </div>
		  <div class="card-body">
			<!-- 手动添加黑名单 -->
			<form id="addBlacklistForm" class="form-grid">
			  <div class="input-group">
				<label for="blacklistBotSelect">选择Bot</label>
				<select id="blacklistBotSelect" class="select-styled"></select>
			  </div>
			  <div class="input-group">
				<label for="blacklistUserId">用户ID</label>
				<input type="text" id="blacklistUserId" required placeholder="输入要拉黑的用户ID">
			  </div>
			  <div class="input-group wide">
				<label for="blacklistReason">拉黑原因（可选）</label>
				<input type="text" id="blacklistReason" placeholder="例如：发送广告、骚扰信息等">
			  </div>
			  <button type="submit" class="btn btn-danger">
				<i class="fas fa-ban"></i> 添加到黑名单
			  </button>
			</form>
			
			<!-- 黑名单列表 -->
			<div class="action-bar" style="margin-top: 20px;">
			  <select id="blacklistViewBotSelect" class="select-styled"></select>
			  <button class="btn btn-secondary" onclick="loadBlacklist()">
				<i class="fas fa-sync"></i> 刷新黑名单
			  </button>
			</div>
			<div id="blacklistDiv" class="blacklist-list"></div>
			
			<!-- 广告关键词配置 -->
			<div class="card-subsection">
			  <h3><i class="fas fa-shield-alt"></i> 广告关键词过滤</h3>
			  <p class="hint-text">当用户消息包含以下关键词时，将自动拉黑（已在后端配置）</p>
			  <div class="keywords-display">
				<span class="keyword-tag">代办</span>
				<span class="keyword-tag">贷款</span>
				<span class="keyword-tag">加微信</span>
				<span class="keyword-tag">加VX</span>
				<span class="keyword-tag">联系qq</span>
				<span class="keyword-tag">私聊</span>
				<span class="keyword-tag">赚钱</span>
				<span class="keyword-tag">兼职</span>
				<span class="keyword-tag">投资</span>
				<span class="keyword-tag">理财</span>
				<span class="keyword-tag">tg频道</span>
				<span class="keyword-tag">推广</span>
				<span class="keyword-tag">广告</span>
				<span class="keyword-tag">合作</span>
				<span class="keyword-tag">引流</span>
				<span class="keyword-tag">刷单</span>
				<span class="keyword-tag">代理</span>
				<span class="keyword-tag">加群</span>
				<span class="keyword-tag">进群</span>
				<span class="keyword-tag">飞机群</span>
			  </div>
			  <p class="hint-text" style="margin-top: 10px;">
				<i class="fas fa-info-circle"></i> 如需自定义关键词，请修改 workers.js 中的 spamKeywords 数组
			  </p>
			</div>
		  </div>
		</section>

      <!-- 发送消息（单发） -->
      <section id="sendMessage" class="card">
        <div class="card-header">
          <h2><i class="fas fa-paper-plane"></i> 发送消息（单发）</h2>
        </div>
        <div class="card-body">
          <form id="sendForm" class="form-grid">
            <div class="input-group">
              <label for="sendBotSelect">选择Bot</label>
              <select id="sendBotSelect" class="select-styled"></select>
            </div>
            <div class="input-group">
              <label for="sendAdminId">管理员ID</label>
              <input type="text" id="sendAdminId" required>
            </div>
            <div class="input-group">
              <label for="sendCustomerIds">客户ID(可多选,用逗号分隔)</label>
              <input type="text" id="sendCustomerIds" required>
            </div>
            <div class="input-group wide">
              <label for="sendMsg">消息内容</label>
              <textarea id="sendMsg" class="textarea-styled"></textarea>
            </div>
            <div class="input-group wide file-upload-group">
              <label>上传文件</label>
              <div class="file-controls">
                <input type="file" id="sendFile" class="file-input">
                <label for="sendFile" class="file-label">选择文件</label>
                <select id="fileType" class="select-styled">
                  <option value="">请选择类型</option>
                  <option value="photo">图片</option>
                  <option value="document">普通文件</option>
                  <option value="video">视频</option>
                  <option value="voice">语音</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> 发送</button>
          </form>
        </div>
      </section>

      <!-- 群发通知 -->
      <section id="broadcast" class="card">
        <div class="card-header">
          <h2><i class="fas fa-broadcast-tower"></i> 群发通知</h2>
        </div>
        <div class="card-body">
          <form id="broadcastForm" class="form-grid">
            <div class="input-group">
              <label for="broadcastBotSelect">选择Bot</label>
              <select id="broadcastBotSelect" class="select-styled"></select>
            </div>
            <div class="input-group">
              <label for="broadcastAdminId">管理员ID</label>
              <input type="text" id="broadcastAdminId" required>
            </div>
            <div class="input-group wide">
              <label for="broadcastMsg">消息内容</label>
              <textarea id="broadcastMsg" class="textarea-styled"></textarea>
            </div>
            <div class="input-group wide file-upload-group">
              <label>上传文件</label>
              <div class="file-controls">
                <input type="file" id="broadcastFile" class="file-input">
                <label for="broadcastFile" class="file-label">选择文件</label>
                <select id="broadcastFileType" class="select-styled">
                  <option value="">请选择类型</option>
                  <option value="photo">图片</option>
                  <option value="document">普通文件</option>
                  <option value="video">视频</option>
                  <option value="voice">语音</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-broadcast-tower"></i> 群发</button>
          </form>
        </div>
      </section>

      <!-- 关键词自动回复 -->
      <section id="keywords" class="card">
        <div class="card-header">
          <h2><i class="fas fa-reply-all"></i> 关键词自动回复</h2>
        </div>
        <div class="card-body">
          <div class="action-bar">
            <select id="kwBotSelect" class="select-styled"></select>
            <button class="btn btn-secondary" onclick="loadKeywords()">
              <i class="fas fa-sync"></i> 刷新
            </button>
          </div>
          
          <form id="kwForm" class="form-grid">
            <div class="input-group">
              <label for="kwType">匹配类型</label>
              <select id="kwType" class="select-styled">
                <option value="equal">精准匹配</option>
                <option value="contain">模糊匹配</option>
              </select>
            </div>
            <div class="input-group">
              <label for="kwKey">关键词</label>
              <input type="text" id="kwKey" placeholder="关键词">
            </div>

            <!-- 回复类型选择 -->
            <div class="input-group wide reply-type-selector">
              <label for="replyType">回复类型</label>
              <select id="replyType" class="select-styled" onchange="toggleReplyFields()">
                <option value="text">文本回复</option>
                <option value="photo">图片回复</option>
                <option value="photo_text">图片+文本回复</option>
              </select>
            </div>
            
            <!-- 文本回复区域 -->
            <div id="textReplyArea" class="reply-area wide">
              <div class="format-toolbar">
                <button type="button" class="format-btn" onclick="insertFormat('bold')"><i class="fas fa-bold"></i></button>
                <button type="button" class="format-btn" onclick="insertFormat('italic')"><i class="fas fa-italic"></i></button>
                <button type="button" class="format-btn" onclick="insertFormat('underline')"><i class="fas fa-underline"></i></button>
                <button type="button" class="format-btn" onclick="insertFormat('strikethrough')"><i class="fas fa-strikethrough"></i></button>
                <button type="button" class="format-btn" onclick="insertFormat('code')"><i class="fas fa-code"></i></button>
                <button type="button" class="format-btn" onclick="insertFormat('pre')"><i class="fas fa-file-code"></i></button>
                <button type="button" class="format-btn" onclick="insertFormat('link')"><i class="fas fa-link"></i></button>
                <div class="format-mode-select">
                  <select id="formatMode" class="select-styled" onchange="updatePreview()">
                    <option value="MarkdownV2">Markdown</option>
                    <option value="HTML">HTML</option>
                  </select>
                </div>
              </div>
              
              <textarea id="kwReply" class="textarea-styled" placeholder="回复内容" oninput="updatePreview()"></textarea>
              
              <div class="preview-container">
                <h4><i class="fas fa-eye"></i> 预览效果 (Telegram 中的显示)</h4>
                <div id="previewContent" class="preview-content"></div>
              </div>
            </div>
            
            <!-- 图片回复区域 -->
            <div id="photoReplyArea" class="reply-area wide" style="display:none;">
              <div class="input-group">
                <label for="photoUrl">图片链接(URL)</label>
                <input type="text" id="photoUrl" placeholder="https://example.com/image.jpg" oninput="updatePhotoPreview()">
              </div>
              <p class="hint-text">支持的图片格式：JPG, JPEG, PNG, GIF, BMP, WEBP</p>
              <div class="photo-preview-area">
                <div id="photoPreview"></div>
              </div>
            </div>
            
            <!-- 图片+文本回复区域 -->
            <div id="photoTextArea" class="reply-area wide" style="display:none;">
              <div class="format-toolbar">
                <button type="button" class="format-btn" onclick="insertFormatCaption('bold')"><i class="fas fa-bold"></i></button>
                <button type="button" class="format-btn" onclick="insertFormatCaption('italic')"><i class="fas fa-italic"></i></button>
                <button type="button" class="format-btn" onclick="insertFormatCaption('underline')"><i class="fas fa-underline"></i></button>
                <button type="button" class="format-btn" onclick="insertFormatCaption('strikethrough')"><i class="fas fa-strikethrough"></i></button>
                <button type="button" class="format-btn" onclick="insertFormatCaption('code')"><i class="fas fa-code"></i></button>
                <button type="button" class="format-btn" onclick="insertFormatCaption('pre')"><i class="fas fa-file-code"></i></button>
                <button type="button" class="format-btn" onclick="insertFormatCaption('link')"><i class="fas fa-link"></i></button>
              </div>
              
              <textarea id="photoCaption" class="textarea-styled" placeholder="图片说明文字" oninput="updateCaptionPreview()"></textarea>
              
              <div class="preview-container">
                <h4><i class="fas fa-eye"></i> 文字预览效果</h4>
                <div id="photoCaptionPreview" class="preview-content"></div>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary wide"><i class="fas fa-plus-circle"></i> 添加关键词</button>
          </form>
          
          <div id="kwList" class="keywords-list"></div>
        </div>
      </section>

      <!-- 启动消息设置 -->
      <section id="startMsg" class="card">
        <div class="card-header">
          <h2><i class="fas fa-play-circle"></i> 启动消息设置</h2>
        </div>
        <div class="card-body">
          <div class="action-bar">
            <select id="startMsgBotSelect" class="select-styled"></select>
          </div>
          <form id="startMsgForm" class="form-grid">
            <div class="input-group">
              <label for="startMsgType">消息类型</label>
              <select id="startMsgType" class="select-styled">
                <option value="none">纯文字</option>
                <option value="photo">图片</option>
              </select>
            </div>
            <div class="input-group wide" id="photoUrlLabel">
              <label for="startMsgPhotoUrl">图片链接</label>
              <div class="input-with-hint">
                <input type="text" id="startMsgPhotoUrl" placeholder="https://image.a5fe.com/xxx.jpg">
                <span class="hint-text">
                  上传到 <a href="https://image.a5fe.com/" target="_blank">图床</a> 后粘贴链接
                </span>
              </div>
            </div>
            <div class="input-group wide">
              <label for="startMsgText">欢迎语内容</label>
              <textarea id="startMsgText" class="textarea-styled" placeholder="请输入启动欢迎语"></textarea>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存</button>
          </form>
        </div>
      </section>

      <!-- API接口列表 -->
      <section id="apiList" class="card">
        <div class="card-header">
          <h2><i class="fas fa-code"></i> API接口列表</h2>
        </div>
        <div class="card-body">
          <div class="api-info">
            <h3>所有API接口基础URL: <code id="apiBaseUrl" class="code-block"></code></h3>
            <p class="hint-text">所有POST/DELETE接口需要在请求体中包含 <code>api_pass</code> 参数进行身份验证</p>
          </div>
          
          <div class="table-container">
            <table class="api-table">
              <thead>
                <tr>
                  <th>接口名称</th>
                  <th>HTTP方法</th>
                  <th>路径</th>
                  <th>参数</th>
                  <th>说明</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>登录验证</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/login</code></td>
                  <td>{password: "密码"}</td>
                  <td>验证后台密码是否正确</td>
                </tr>
                <tr>
                  <td>获取Bot列表</td>
                  <td><span class="http-method get">GET</span></td>
                  <td><code>/api/bots</code></td>
                  <td>无</td>
                  <td>获取所有配置的Bot</td>
                </tr>
                <tr>
                  <td>添加/更新Bot</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/bots</code></td>
                  <td>{api_pass, bot_name, token, admins}</td>
                  <td>添加或更新Bot配置</td>
                </tr>
                <tr>
                  <td>删除Bot</td>
                  <td><span class="http-method delete">DELETE</span></td>
                  <td><code>/api/bots</code></td>
                  <td>{api_pass, bot_name}</td>
                  <td>删除Bot配置</td>
                </tr>
                <tr>
                  <td>获取客户列表</td>
                  <td><span class="http-method get">GET</span></td>
                  <td><code>/api/customers/{bot_name}</code></td>
                  <td>无</td>
                  <td>获取特定Bot的客户ID列表</td>
                </tr>
                <tr>
                  <td>获取停用用户</td>
                  <td><span class="http-method get">GET</span></td>
                  <td><code>/api/blocked?bot_name={bot_name}</code></td>
                  <td>无</td>
                  <td>获取已停用机器人的用户</td>
                </tr>
                <tr>
                  <td>添加停用用户</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/blocked</code></td>
                  <td>{api_pass, bot_name, user_id}</td>
                  <td>将用户标记为已停用</td>
                </tr>
                <tr>
                  <td>移除停用用户</td>
                  <td><span class="http-method delete">DELETE</span></td>
                  <td><code>/api/blocked</code></td>
                  <td>{api_pass, bot_name, user_id}</td>
                  <td>移除用户的停用标记</td>
                </tr>
                <tr>
                  <td>发送消息</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/send</code></td>
                  <td>{api_pass, bot_name, admin_id, customer_ids, text, fileType, fileUrl}</td>
                  <td>发送消息给指定用户</td>
                </tr>
                <tr>
                  <td>群发消息</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/broadcast</code></td>
                  <td>{api_pass, bot_name, admin_id, text, fileType, fileUrl}</td>
                  <td>群发消息给所有用户</td>
                </tr>
                <tr>
                  <td>获取关键词列表</td>
                  <td><span class="http-method get">GET</span></td>
                  <td><code>/api/keywords?bot_name={bot_name}</code></td>
                  <td>无</td>
                  <td>获取Bot的关键词自动回复</td>
                </tr>
                <tr>
                  <td>添加关键词</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/keywords</code></td>
                  <td>{api_pass, bot_name, type, keyword, reply, parse_mode, reply_type, photo_url, caption}</td>
                  <td>添加自动回复关键词</td>
                </tr>
                <tr>
                  <td>删除关键词</td>
                  <td><span class="http-method delete">DELETE</span></td>
                  <td><code>/api/keywords</code></td>
                  <td>{api_pass, bot_name, idx}</td>
                  <td>删除指定位置的关键词</td>
                </tr>
                <tr>
                  <td>获取启动消息</td>
                  <td><span class="http-method get">GET</span></td>
                  <td><code>/api/startmsg?bot_name={bot_name}</code></td>
                  <td>无</td>
                  <td>获取Bot的启动欢迎消息</td>
                </tr>
                <tr>
                  <td>设置启动消息</td>
                  <td><span class="http-method post">POST</span></td>
                  <td><code>/api/startmsg</code></td>
                  <td>{api_pass, bot_name, type, fileUrl, caption}</td>
                  <td>设置Bot的启动欢迎消息</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- 模态框 -->
  <div id="modal" class="modal">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <script src="script.js"></script>
</body>
</html>