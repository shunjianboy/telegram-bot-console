export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // 统一返回JSON并加CORS头
    function jsonResponse(body, status = 200, extraHeaders = {}) {
      return new Response(
        typeof body === "string" ? body : JSON.stringify(body),
        {
          status,
          headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*",
            ...extraHeaders,
          },
        }
      );
    }

    // 生成简单Token（实际项目建议用JWT）
    function genToken() {
      // 时间戳+随机数+签名hash（这里只做简单示例）
      return btoa(Date.now() + ":" + Math.random() + ":" + env.ADMIN_PASS);
    }

    // 校验token是否有效
    function checkAuth(request) {
      const auth = request.headers.get("Authorization");
      if (!auth || !auth.startsWith("Bearer ")) return false;
      const token = auth.slice(7);
      // 实际项目建议用JWT并校验过期时间，这里只做演示
      // 简单校验token格式里包含ADMIN_PASS
      try {
        const decoded = atob(token);
        if (decoded.includes(env.ADMIN_PASS)) return true;
      } catch {}
      return false;
    }

    // 处理 CORS 预检
    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type,Authorization",
        },
      });
    }

    // 登录接口
    if (url.pathname === "/api/login" && request.method === "POST") {
      try {
        const { password } = await request.json();
        if (password === env.ADMIN_PASS) {
          const token = genToken();
          return jsonResponse({ ok: true, token });
        }
        return jsonResponse({ ok: false, error: "密码错误" }, 401);
      } catch (err) {
        return jsonResponse({ ok: false, error: err.message }, 500);
      }
    }

    // 需要认证的接口
    if (url.pathname === "/api/send" && request.method === "POST") {
      if (!checkAuth(request)) {
        return jsonResponse({ ok: false, error: "未授权，请重新登录" }, 401);
      }
      try {
        const { chat_id, text } = await request.json();
        const tgRes = await fetch(
          `https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id, text }),
          }
        );
        const tgResult = await tgRes.text();
        let result;
        try {
          result = JSON.parse(tgResult);
        } catch {
          result = tgResult;
        }
        return jsonResponse(result, tgRes.status);
      } catch (err) {
        return jsonResponse({ ok: false, error: err.message }, 500);
      }
    }

    if (url.pathname === "/api/logs" && request.method === "GET") {
      if (!checkAuth(request)) {
        return jsonResponse({ ok: false, error: "未授权，请重新登录" }, 401);
      }
      try {
        if (!env.telegram_bot)
          return jsonResponse("D1 数据库未绑定", 500);
        const { results } = await env.telegram_bot
          .prepare(
            "SELECT * FROM chat_logs ORDER BY created_at DESC LIMIT 10"
          )
          .all();
        return jsonResponse(results);
      } catch (err) {
        return jsonResponse({ ok: false, error: err.message }, 500);
      }
    }

    if (url.pathname === "/api/lastmsg" && request.method === "GET") {
      if (!checkAuth(request)) {
        return jsonResponse({ ok: false, error: "未授权，请重新登录" }, 401);
      }
      try {
        const chat_id = url.searchParams.get("chat_id");
        if (!chat_id) return jsonResponse("缺少 chat_id", 400);
        if (!env.TELEGRAM_BOT_USERS)
          return jsonResponse("KV 未绑定", 500);
        const msg = await env.TELEGRAM_BOT_USERS.get(`last_msg_${chat_id}`);
        return jsonResponse(msg ?? "无记录");
      } catch (err) {
        return jsonResponse({ ok: false, error: err.message }, 500);
      }
    }

    // Webhook接口不需要Auth
    if (url.pathname === "/api/webhook" && request.method === "POST") {
      try {
        const update = await request.json();
        if (update.message) {
          const chat_id = update.message.chat.id;
          const text = update.message.text;
          // 存储到 D1
          if (env.telegram_bot) {
            await env.telegram_bot
              .prepare(
                "INSERT INTO chat_logs (chat_id, message, created_at) VALUES (?, ?, ?)"
              )
              .bind(chat_id, text, Date.now())
              .run();
          }
          // 存储到 KV
          if (env.TELEGRAM_BOT_USERS) {
            await env.TELEGRAM_BOT_USERS.put(`last_msg_${chat_id}`, text);
          }
          // 自动回复
          const reply = `你刚刚说了：${text}`;
          await fetch(
            `https://api.telegram.org/bot${env.TELEGRAM_BOT_TOKEN}/sendMessage`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ chat_id, text: reply }),
            }
          );
        }
        return jsonResponse({ ok: true });
      } catch (err) {
        return jsonResponse({ ok: false, error: err.message }, 500);
      }
    }

    // 默认404
    return jsonResponse("Not found", 404);
  },
};
