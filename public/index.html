<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot 管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .login-container {
            width: 100%;
            max-width: 400px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .admin-container {
            width: 100%;
            max-width: 1000px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: none;
        }
        .error-message {
            color: #dc3545;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 5px;
            display: none;
        }
        .tab-content {
            padding: 20px 0;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
        .spinner-container .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="spinner-container" id="globalSpinner">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <h2 class="mb-4">Telegram Bot 管理后台登录</h2>
        <div class="mb-3">
            <label for="adminPassword" class="form-label">管理密码</label>
            <input type="password" class="form-control" id="adminPassword" placeholder="请输入管理密码">
        </div>
        <button class="btn btn-primary w-100" id="loginButton">
            <span id="loginText">登录</span>
            <span id="loginSpinner" class="loading d-none"></span>
        </button>
        <div class="error-message" id="loginError">密码错误，请重试</div>
    </div>

    <!-- 管理后台界面 -->
    <div class="admin-container" id="adminContainer">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Telegram Bot 管理后台</h2>
            <button class="btn btn-danger" id="logoutButton">退出登录</button>
        </div>

        <!-- 导航标签 -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="botManage-tab" data-bs-toggle="tab" data-bs-target="#botManage" type="button" role="tab" aria-controls="botManage" aria-selected="true">Bot 管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="keywords-tab" data-bs-toggle="tab" data-bs-target="#keywords" type="button" role="tab" aria-controls="keywords" aria-selected="false">关键词回复</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="startMsg-tab" data-bs-toggle="tab" data-bs-target="#startMsg" type="button" role="tab" aria-controls="startMsg" aria-selected="false">启动消息</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcast" type="button" role="tab" aria-controls="broadcast" aria-selected="false">群发消息</button>
            </li>
        </ul>

        <!-- 标签内容 -->
        <div class="tab-content" id="adminTabsContent">
            <!-- Bot管理标签 -->
            <div class="tab-pane fade show active" id="botManage" role="tabpanel" aria-labelledby="botManage-tab">
                <h4 class="mb-3">Bot 配置管理</h4>
                <div class="mb-4">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addBotModal">添加新 Bot</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Bot 名称</th>
                                <th>Token</th>
                                <th>管理员 IDs</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="botList">
                            <!-- Bot 列表将通过JS动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 关键词回复标签 -->
            <div class="tab-pane fade" id="keywords" role="tabpanel" aria-labelledby="keywords-tab">
                <div class="mb-3">
                    <label for="keywordBotSelect" class="form-label">选择 Bot</label>
                    <select class="form-select" id="keywordBotSelect"></select>
                </div>
                <h4 class="mb-3">关键词自动回复</h4>
                <div class="mb-4">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addKeywordModal">添加新关键词</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>匹配方式</th>
                                <th>关键词</th>
                                <th>回复内容</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="keywordsList">
                            <!-- 关键词列表将通过JS动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 启动消息标签 -->
            <div class="tab-pane fade" id="startMsg" role="tabpanel" aria-labelledby="startMsg-tab">
                <div class="mb-3">
                    <label for="startMsgBotSelect" class="form-label">选择 Bot</label>
                    <select class="form-select" id="startMsgBotSelect"></select>
                </div>
                <h4 class="mb-3">启动消息设置</h4>
                <form id="startMsgForm">
                    <div class="mb-3">
                        <label class="form-label">消息类型</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="startMsgType" id="startMsgTypeText" value="none" checked>
                            <label class="form-check-label" for="startMsgTypeText">纯文本</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="startMsgType" id="startMsgTypePhoto" value="photo">
                            <label class="form-check-label" for="startMsgTypePhoto">图片</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="startMsgType" id="startMsgTypeVideo" value="video">
                            <label class="form-check-label" for="startMsgTypeVideo">视频</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="startMsgType" id="startMsgTypeDocument" value="document">
                            <label class="form-check-label" for="startMsgTypeDocument">文件</label>
                        </div>
                    </div>
                    <div class="mb-3" id="fileUrlContainer" style="display: none;">
                        <label for="startMsgFileUrl" class="form-label">文件URL</label>
                        <input type="text" class="form-control" id="startMsgFileUrl" placeholder="输入文件URL (Telegram文件ID或网络URL)">
                        <small class="text-muted">可以是网络URL或Telegram文件ID</small>
                    </div>
                    <div class="mb-3">
                        <label for="startMsgCaption" class="form-label">消息内容/说明</label>
                        <textarea class="form-control" id="startMsgCaption" rows="4" placeholder="输入欢迎消息或文件说明"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                    <div class="alert alert-success mt-3" id="startMsgSuccess" style="display: none;">设置保存成功！</div>
                    <div class="alert alert-danger mt-3" id="startMsgError" style="display: none;">保存失败，请重试</div>
                </form>
            </div>

            <!-- 群发消息标签 -->
            <div class="tab-pane fade" id="broadcast" role="tabpanel" aria-labelledby="broadcast-tab">
                <div class="mb-3">
                    <label for="broadcastBotSelect" class="form-label">选择 Bot</label>
                    <select class="form-select" id="broadcastBotSelect"></select>
                </div>
                <h4 class="mb-3">群发消息</h4>
                <div class="mb-3">
                    <label class="form-label">消息类型</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="msgType" id="msgTypeText" value="text" checked>
                        <label class="form-check-label" for="msgTypeText">纯文本</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="msgType" id="msgTypePhoto" value="photo">
                        <label class="form-check-label" for="msgTypePhoto">图片</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="msgType" id="msgTypeDocument" value="document">
                        <label class="form-check-label" for="msgTypeDocument">文件</label>
                    </div>
                </div>
                <div class="mb-3" id="broadcastFileContainer" style="display: none;">
                    <label for="broadcastFileUrl" class="form-label">文件URL</label>
                    <input type="text" class="form-control" id="broadcastFileUrl" placeholder="输入文件URL (Telegram文件ID或网络URL)">
                    <small class="text-muted">可以是网络URL或Telegram文件ID</small>
                </div>
                <div class="mb-3">
                    <label for="broadcastText" class="form-label">消息内容/图片说明</label>
                    <textarea class="form-control" id="broadcastText" rows="4" placeholder="输入要群发的消息"></textarea>
                </div>
                <button class="btn btn-primary" id="sendBroadcastButton">发送给所有用户</button>
                <div class="alert alert-success mt-3" id="broadcastSuccess" style="display: none;">消息群发成功！</div>
                <div class="alert alert-danger mt-3" id="broadcastError" style="display: none;">发送失败，请重试</div>
            </div>
        </div>
    </div>

    <!-- 添加Bot模态框 -->
    <div class="modal fade" id="addBotModal" tabindex="-1" aria-labelledby="addBotModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBotModalLabel">添加新Bot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addBotForm">
                        <div class="mb-3">
                            <label for="botName" class="form-label">Bot 名称</label>
                            <input type="text" class="form-control" id="botName" required>
                            <small class="text-muted">用于标识Bot，不带@符号</small>
                        </div>
                        <div class="mb-3">
                            <label for="botToken" class="form-label">Bot Token</label>
                            <input type="text" class="form-control" id="botToken" required>
                            <small class="text-muted">从 @BotFather 获取的Token</small>
                        </div>
                        <div class="mb-3">
                            <label for="botAdmins" class="form-label">管理员ID列表</label>
                            <input type="text" class="form-control" id="botAdmins" required>
                            <small class="text-muted">用英文逗号分隔多个管理员ID</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveBotButton">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加关键词模态框 -->
    <div class="modal fade" id="addKeywordModal" tabindex="-1" aria-labelledby="addKeywordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addKeywordModalLabel">添加关键词</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addKeywordForm">
                        <div class="mb-3">
                            <label class="form-label">匹配方式</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="keywordType" id="keywordTypeEqual" value="equal" checked>
                                <label class="form-check-label" for="keywordTypeEqual">完全匹配</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="keywordType" id="keywordTypeContain" value="contain">
                                <label class="form-check-label" for="keywordTypeContain">包含匹配</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="keyword" class="form-label">关键词</label>
                            <input type="text" class="form-control" id="keyword" required>
                        </div>
                        <div class="mb-3">
                            <label for="replyText" class="form-label">回复内容</label>
                            <textarea class="form-control" id="replyText" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveKeywordButton">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let adminPassword = '';
        let currentBots = {};
        
        // 显示/隐藏全局加载动画
        function showSpinner() {
            document.getElementById('globalSpinner').style.display = 'flex';
        }
        
        function hideSpinner() {
            document.getElementById('globalSpinner').style.display = 'none';
        }
        
        // API 请求函数
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(endpoint, options);
            return await response.json();
        }
        
        // 登录函数
        async function login() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showLoginError('请输入密码');
                return;
            }
            
            document.getElementById('loginText').style.display = 'none';
            document.getElementById('loginSpinner').classList.remove('d-none');
            
            try {
                const result = await apiRequest('/api/login', 'POST', { password });
                
                if (result.ok) {
                    adminPassword = password;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminContainer').style.display = 'block';
                    loadBots();
                } else {
                    showLoginError(result.error || '密码错误，请重试');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('网络错误，请重试');
            } finally {
                document.getElementById('loginText').style.display = 'block';
                document.getElementById('loginSpinner').classList.add('d-none');
            }
        }
        
        // 显示登录错误
        function showLoginError(message) {
            const errorElement = document.getElementById('loginError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }
        
        // 加载Bot列表
        async function loadBots() {
            showSpinner();
            try {
                const bots = await apiRequest('/api/bots');
                currentBots = bots;
                
                // 更新Bot列表表格
                const botListElement = document.getElementById('botList');
                botListElement.innerHTML = '';
                
                if (Object.keys(bots).length === 0) {
                    botListElement.innerHTML = '<tr><td colspan="4" class="text-center">暂无Bot配置</td></tr>';
                } else {
                    Object.entries(bots).forEach(([botName, botInfo]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${botName}</td>
                            <td>${maskToken(botInfo.token)}</td>
                            <td>${botInfo.admins.join(', ')}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteBot('${botName}')">删除</button>
                            </td>
                        `;
                        botListElement.appendChild(row);
                    });
                }
                
                // 更新所有Bot选择下拉框
                updateBotSelects(bots);
                
            } catch (error) {
                console.error('Error loading bots:', error);
                alert('加载Bot列表失败，请刷新页面重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 更新所有Bot选择下拉框
        function updateBotSelects(bots) {
            const selects = ['keywordBotSelect', 'startMsgBotSelect', 'broadcastBotSelect'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                
                if (Object.keys(bots).length === 0) {
                    select.innerHTML = '<option value="">暂无Bot配置</option>';
                    select.disabled = true;
                } else {
                    select.disabled = false;
                    Object.keys(bots).forEach(botName => {
                        const option = document.createElement('option');
                        option.value = botName;
                        option.textContent = botName;
                        select.appendChild(option);
                    });
                    
                    // 触发选择变化事件以加载相关数据
                    if (selectId === 'keywordBotSelect') {
                        loadKeywords();
                    } else if (selectId === 'startMsgBotSelect') {
                        loadStartMsg();
                    }
                }
            });
        }
        
        // 掩盖Token显示
        function maskToken(token) {
            if (!token) return '';
            if (token.length <= 8) return '********';
            return token.substring(0, 4) + '...' + token.substring(token.length - 4);
        }
        
        // 添加新Bot
        async function addBot() {
            const name = document.getElementById('botName').value.trim();
            const token = document.getElementById('botToken').value.trim();
            const adminsInput = document.getElementById('botAdmins').value.trim();
            
            if (!name || !token || !adminsInput) {
                alert('请填写所有必填字段');
                return;
            }
            
            // 处理管理员ID列表
            const admins = adminsInput.split(',').map(id => id.trim()).filter(id => id);
            
            if (admins.length === 0) {
                alert('至少需要一个管理员ID');
                return;
            }
            
            showSpinner();
            try {
                const result = await apiRequest('/api/bots', 'POST', {
                    api_pass: adminPassword,
                    bot_name: name,
                    token: token,
                    admins: admins
                });
                
                if (result.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addBotModal'));
                    modal.hide();
                    document.getElementById('addBotForm').reset();
                    loadBots();
                    
                    if (result.warning) {
                        alert(`Bot添加成功，但有警告：${result.warning}`);
                    }
                } else {
                    alert(`添加失败：${result.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('Error adding bot:', error);
                alert('网络错误，请重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 删除Bot
        async function deleteBot(botName) {
            if (!confirm(`确定要删除 ${botName} 吗？此操作不可撤销。`)) {
                return;
            }
            
            showSpinner();
            try {
                const result = await apiRequest('/api/bots', 'DELETE', {
                    api_pass: adminPassword,
                    bot_name: botName
                });
                
                if (result.ok) {
                    loadBots();
                } else {
                    alert(`删除失败：${result.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('Error deleting bot:', error);
                alert('网络错误，请重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 加载关键词列表
        async function loadKeywords() {
            const select = document.getElementById('keywordBotSelect');
            if (!select.value) return;
            
            showSpinner();
            try {
                const keywords = await apiRequest(`/api/keywords?bot_name=${encodeURIComponent(select.value)}`);
                
                const keywordsListElement = document.getElementById('keywordsList');
                keywordsListElement.innerHTML = '';
                
                if (keywords.length === 0) {
                    keywordsListElement.innerHTML = '<tr><td colspan="4" class="text-center">暂无关键词配置</td></tr>';
                } else {
                    keywords.forEach((keyword, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${keyword.type === 'equal' ? '完全匹配' : '包含匹配'}</td>
                            <td>${keyword.keyword}</td>
                            <td>${keyword.reply.length > 30 ? keyword.reply.substring(0, 30) + '...' : keyword.reply}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteKeyword(${index})">删除</button>
                            </td>
                        `;
                        keywordsListElement.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading keywords:', error);
                alert('加载关键词失败，请重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 添加关键词
        async function addKeyword() {
            const botName = document.getElementById('keywordBotSelect').value;
            if (!botName) {
                alert('请先选择一个Bot');
                return;
            }
            
            const keywordType = document.querySelector('input[name="keywordType"]:checked').value;
            const keyword = document.getElementById('keyword').value.trim();
            const reply = document.getElementById('replyText').value.trim();
            
            if (!keyword || !reply) {
                alert('请填写关键词和回复内容');
                return;
            }
            
            showSpinner();
            try {
                const result = await apiRequest('/api/keywords', 'POST', {
                    api_pass: adminPassword,
                    bot_name: botName,
                    type: keywordType,
                    keyword: keyword,
                    reply: reply
                });
                
                if (result.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addKeywordModal'));
                    modal.hide();
                    document.getElementById('addKeywordForm').reset();
                    loadKeywords();
                } else {
                    alert(`添加失败：${result.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('Error adding keyword:', error);
                alert('网络错误，请重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 删除关键词
        async function deleteKeyword(index) {
            const botName = document.getElementById('keywordBotSelect').value;
            if (!botName) return;
            
            if (!confirm('确定要删除此关键词吗？')) {
                return;
            }
            
            showSpinner();
            try {
                const result = await apiRequest('/api/keywords', 'DELETE', {
                    api_pass: adminPassword,
                    bot_name: botName,
                    idx: index
                });
                
                if (result.ok) {
                    loadKeywords();
                } else {
                    alert(`删除失败：${result.error || '未知错误'}`);
                }
            } catch (error) {
                console.error('Error deleting keyword:', error);
                alert('网络错误，请重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 加载启动消息设置
        async function loadStartMsg() {
            const select = document.getElementById('startMsgBotSelect');
            if (!select.value) return;
            
            showSpinner();
            try {
                const startMsg = await apiRequest(`/api/startmsg?bot_name=${encodeURIComponent(select.value)}`);
                
                // 设置表单值
                document.querySelector(`input[name="startMsgType"][value="${startMsg.type || 'none'}"]`).checked = true;
                document.getElementById('startMsgFileUrl').value = startMsg.fileUrl || '';
                document.getElementById('startMsgCaption').value = startMsg.caption || '';
                
                // 根据消息类型显示/隐藏文件URL输入框
                toggleFileUrlInput();
                
            } catch (error) {
                console.error('Error loading start message:', error);
                alert('加载启动消息设置失败，请重试');
            } finally {
                hideSpinner();
            }
        }
        
        // 保存启动消息设置
        async function saveStartMsg(event) {
            event.preventDefault();
            
            const botName = document.getElementById('startMsgBotSelect').value;
            if (!botName) {
                alert('请先选择一个Bot');
                return;
            }
            
            const type = document.querySelector('input[name="startMsgType"]:checked').value;
            const fileUrl = document.getElementById('startMsgFileUrl').value.trim();
            const caption = document.getElementById('startMsgCaption').value.trim();
            
            // 验证：如果选择了图片/视频/文档，则必须提供文件URL
            if (type !== 'none' && !fileUrl) {
                alert('请提供文件URL');
                return;
            }
            
            showSpinner();
            try {
                const result = await apiRequest('/api/startmsg', 'POST', {
                    api_pass: adminPassword,
                    bot_name: botName,
                    type: type,
                    fileUrl: fileUrl,
                    caption: caption
                });
                
                if (result.ok) {
                    const successMsg = document.getElementById('startMsgSuccess');
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                } else {
                    const errorMsg = document.getElementById('startMsgError');
                    errorMsg.textContent = result.error || '保存失败，请重试';
                    errorMsg.style.display = 'block';
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error saving start message:', error);
                const errorMsg = document.getElementById('startMsgError');
                errorMsg.textContent = '网络错误，请重试';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 3000);
            } finally {
                hideSpinner();
            }
        }
        
        // 根据消息类型显示/隐藏文件URL输入框
        function toggleFileUrlInput() {
            const type = document.querySelector('input[name="startMsgType"]:checked').value;
            const fileUrlContainer = document.getElementById('fileUrlContainer');
            
            if (type === 'none') {
                fileUrlContainer.style.display = 'none';
            } else {
                fileUrlContainer.style.display = 'block';
            }
        }
        
        // 根据消息类型显示/隐藏群发消息的文件URL输入框
        function toggleBroadcastFileInput() {
            const type = document.querySelector('input[name="msgType"]:checked').value;
            const fileContainer = document.getElementById('broadcastFileContainer');
            
            if (type === 'text') {
                fileContainer.style.display = 'none';
            } else {
                fileContainer.style.display = 'block';
            }
        }
        
        // 发送群发消息
        async function sendBroadcast() {
            const botName = document.getElementById('broadcastBotSelect').value;
            if (!botName) {
                alert('请先选择一个Bot');
                return;
            }
            
            const fileType = document.querySelector('input[name="msgType"]:checked').value;
            const fileUrl = document.getElementById('broadcastFileUrl').value.trim();
            const text = document.getElementById('broadcastText').value.trim();
            
            // 验证
            if (fileType !== 'text' && !fileUrl) {
                alert('请提供文件URL');
                return;
            }
            
            if (fileType === 'text' && !text) {
                alert('请输入要发送的消息内容');
                return;
            }
            
            if (!confirm('确定要给所有用户发送此消息吗？此操作不可撤销。')) {
                return;
            }
            
            // 获取Bot信息中的第一个管理员ID
            const adminId = currentBots[botName].admins[0];
            if (!adminId) {
                alert('未找到管理员ID');
                return;
            }
            
            showSpinner();
            try {
                const result = await apiRequest('/api/broadcast', 'POST', {
                    api_pass: adminPassword,
                    bot_name: botName,
                    admin_id: adminId,
                    text: text,
                    fileType: fileType === 'text' ? null : fileType,
                    fileUrl: fileType === 'text' ? null : fileUrl
                });
                
                if (result.ok) {
                    const successMsg = document.getElementById('broadcastSuccess');
                    successMsg.textContent = `消息已成功发送给 ${result.count - (result.failedUsers ? result.failedUsers.length : 0)} 位用户${result.warnings ? '，但有部分用户发送失败' : ''}`;
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 5000);
                    
                    // 重置表单
                    document.getElementById('broadcastText').value = '';
                    document.getElementById('broadcastFileUrl').value = '';
                    document.getElementById('msgTypeText').checked = true;
                    toggleBroadcastFileInput();
                } else {
                    const errorMsg = document.getElementById('broadcastError');
                    errorMsg.textContent = result.error || '发送失败，请重试';
                    errorMsg.style.display = 'block';
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error sending broadcast:', error);
                const errorMsg = document.getElementById('broadcastError');
                errorMsg.textContent = '网络错误，请重试';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    errorMsg.style.display = 'none';
                }, 3000);
            } finally {
                hideSpinner();
            }
        }
        
        // 退出登录
        function logout() {
            adminPassword = '';
            document.getElementById('adminContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminPassword').value = '';
        }
        
        // 初始化事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 登录按钮点击
            document.getElementById('loginButton').addEventListener('click', login);
            
            // 登录表单回车提交
            document.getElementById('adminPassword').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    login();
                }
            });
            
            // 退出登录按钮
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // 保存Bot按钮
            document.getElementById('saveBotButton').addEventListener('click', addBot);
            
            // 保存关键词按钮
            document.getElementById('saveKeywordButton').addEventListener('click', addKeyword);
            
            // 启动消息表单提交
            document.getElementById('startMsgForm').addEventListener('submit', saveStartMsg);
            
            // 启动消息类型切换时显示/隐藏文件URL输入框
            document.querySelectorAll('input[name="startMsgType"]').forEach(radio => {
                radio.addEventListener('change', toggleFileUrlInput);
            });
            
            // 群发消息类型切换
            document.querySelectorAll('input[name="msgType"]').forEach(radio => {
                radio.addEventListener('change', toggleBroadcastFileInput);
            });
            
            // Bot选择变化事件
            document.getElementById('keywordBotSelect').addEventListener('change', loadKeywords);
            document.getElementById('startMsgBotSelect').addEventListener('change', loadStartMsg);
            
            // 发送群发消息按钮
            document.getElementById('sendBroadcastButton').addEventListener('click', sendBroadcast);
        });
    </script>
</body>
</html>
