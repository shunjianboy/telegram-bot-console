export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    function jsonResponse(body, status = 200) {
      return new Response(
        typeof body === "string" ? body : JSON.stringify(body),
        {
          status,
          headers: {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*"
          }
        }
      );
    }

    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET,POST,DELETE,OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type,Authorization",
        },
      });
    }

    try {
      // ç™»å½•
      if (url.pathname === "/api/login" && request.method === "POST") {
        const { password } = await request.json();
        if (password && password === env.ADMIN_PASS) {
          return jsonResponse({ ok: true });
        }
        return jsonResponse({ ok: false, error: "å¯†ç é”™è¯¯" }, 401);
      }

      // è·å–æ‰€æœ‰Boté…ç½®
      if (url.pathname === "/api/bots" && request.method === "GET") {
        const bots = await env.TELEGRAM_BOT_USERS.get("bots", "json") || {};
        return jsonResponse(bots);
      }
      // æ–°å¢/æ›´æ–°Boté…ç½® + è‡ªåŠ¨è®¾ç½®Webhook
      if (url.pathname === "/api/bots" && request.method === "POST") {
        const { api_pass, bot_name, token, admins } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let bots = await env.TELEGRAM_BOT_USERS.get("bots", "json") || {};
        bots[bot_name] = { token, admins };
        await env.TELEGRAM_BOT_USERS.put("bots", JSON.stringify(bots));
        // è‡ªåŠ¨è®¾ç½®Webhook
        try {
          const webhookUrl = `https://${url.hostname}/webhook/${bot_name}`;
          const r = await fetch(`https://api.telegram.org/bot${token}/setWebhook?url=${encodeURIComponent(webhookUrl)}`);
          const setWebhookResult = await r.json();
          if (!setWebhookResult.ok) {
            return jsonResponse({ok:true, warning: "Botå·²æ·»åŠ ï¼Œä½†è®¾ç½®Webhookå¤±è´¥ï¼š"+setWebhookResult.description});
          }
        } catch(e) {}
        return jsonResponse({ok:true});
      }
      // åˆ é™¤Boté…ç½®
      if (url.pathname === "/api/bots" && request.method === "DELETE") {
        const { api_pass, bot_name } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let bots = await env.TELEGRAM_BOT_USERS.get("bots", "json") || {};
        if (bots[bot_name]) {
          delete bots[bot_name];
          await env.TELEGRAM_BOT_USERS.put("bots", JSON.stringify(bots));
          return jsonResponse({ok:true});
        } else {
          return jsonResponse({ok:false,error:"æœªæ‰¾åˆ°Bot"},404);
        }
      }

      // è·å–å®¢æˆ·IDåˆ—è¡¨
      if (url.pathname.startsWith("/api/customers/") && request.method === "GET") {
        const bot_name = decodeURIComponent(url.pathname.split("/").pop());
        const { results } = await env.telegram_bot.prepare(
          "SELECT DISTINCT user_id FROM chat_logs WHERE bot_name = ?"
        ).bind(bot_name).all();
        const ids = results.map(r => r.user_id);
        return jsonResponse(ids);
      }

      // å¯åŠ¨æ¶ˆæ¯æŸ¥è¯¢
      if (url.pathname === "/api/startmsg" && request.method === "GET") {
        const bot_name = url.searchParams.get("bot_name");
        const startmsg = await env.TELEGRAM_BOT_USERS.get(`startmsg_${bot_name}`, "json") || {type:"none"};
        return jsonResponse(startmsg);
      }
      // å¯åŠ¨æ¶ˆæ¯è®¾ç½®
      if (url.pathname === "/api/startmsg" && request.method === "POST") {
        const { api_pass, bot_name, type, fileUrl, caption } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        await env.TELEGRAM_BOT_USERS.put(`startmsg_${bot_name}`, JSON.stringify({type, fileUrl, caption}));
        return jsonResponse({ok:true});
      }

      // ç¾¤å‘é€šçŸ¥
      if (url.pathname === "/api/broadcast" && request.method === "POST") {
        const { api_pass, bot_name, admin_id, text, fileType, fileUrl } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let bots = await env.TELEGRAM_BOT_USERS.get("bots", "json") || {};
        const bot = bots[bot_name];
        if (!bot || !bot.admins.includes(admin_id)) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);

        // æŸ¥æ‰¾è¯¥botæ‰€æœ‰èŠè¿‡å¤©çš„ç”¨æˆ·
        const { results } = await env.telegram_bot.prepare(
          "SELECT DISTINCT user_id FROM chat_logs WHERE bot_name = ?"
        ).bind(bot_name).all();
        const customer_ids = results.map(r => r.user_id);

        let resultsArr = [];
        for(const id of customer_ids){
          let api = "sendMessage";
          let data = {chat_id: id, text: text};
          if (fileType && fileUrl) {
            if (fileType === "photo") {
              api = "sendPhoto";
              data = {chat_id: id, photo: fileUrl, caption: text || ""};
            } else if (fileType === "document") {
              api = "sendDocument";
              data = {chat_id: id, document: fileUrl, caption: text || ""};
            }
          }
          const res = await fetch(`https://api.telegram.org/bot${bot.token}/${api}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(data)
          });
          const result = await res.json();
          resultsArr.push(result);
        }
        return jsonResponse({ok:true, results: resultsArr, count: customer_ids.length});
      }

      // ç®¡ç†åå°å‘æ¶ˆæ¯/æ–‡ä»¶ï¼ˆå•å‘ï¼‰
      if (url.pathname === "/api/send" && request.method === "POST") {
        const { api_pass, bot_name, admin_id, customer_ids, text, fileType, fileUrl } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let bots = await env.TELEGRAM_BOT_USERS.get("bots", "json") || {};
        const bot = bots[bot_name];
        if (!bot || !bot.admins.includes(admin_id)) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let results = [];
        for(const id of customer_ids){
          let api = "sendMessage";
          let data = {chat_id: id, text: text};
          if (fileType && fileUrl) {
            if (fileType === "photo") {
              api = "sendPhoto";
              data = {chat_id: id, photo: fileUrl, caption: text || ""};
            } else if (fileType === "document") {
              api = "sendDocument";
              data = {chat_id: id, document: fileUrl, caption: text || ""};
            }
          }
          const res = await fetch(`https://api.telegram.org/bot${bot.token}/${api}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(data)
          });
          const result = await res.json();
          results.push(result);
        }
        return jsonResponse({ok:true, results});
      }

      // å…³é”®è¯è‡ªåŠ¨å›å¤API
      // æŸ¥è¯¢
      if (url.pathname === "/api/keywords" && request.method === "GET") {
        const bot_name = url.searchParams.get("bot_name");
        const keywords = await env.TELEGRAM_BOT_USERS.get(`keywords_${bot_name}`, "json") || [];
        return jsonResponse(keywords);
      }
      // æ·»åŠ 
      if (url.pathname === "/api/keywords" && request.method === "POST") {
        const { api_pass, bot_name, type, keyword, reply } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let keywords = await env.TELEGRAM_BOT_USERS.get(`keywords_${bot_name}`, "json") || [];
        keywords.push({type, keyword, reply});
        await env.TELEGRAM_BOT_USERS.put(`keywords_${bot_name}`, JSON.stringify(keywords));
        return jsonResponse({ok:true});
      }
      // åˆ é™¤
      if (url.pathname === "/api/keywords" && request.method === "DELETE") {
        const { api_pass, bot_name, idx } = await request.json();
        if (api_pass !== env.ADMIN_PASS) return jsonResponse({ok:false,error:"æœªæˆæƒ"},401);
        let keywords = await env.TELEGRAM_BOT_USERS.get(`keywords_${bot_name}`, "json") || [];
        keywords.splice(idx,1);
        await env.TELEGRAM_BOT_USERS.put(`keywords_${bot_name}`, JSON.stringify(keywords));
        return jsonResponse({ok:true});
      }

      // ========== Telegram Webhook ==========
      if (url.pathname.startsWith("/webhook/") && request.method === "POST") {
        const bot_name = decodeURIComponent(url.pathname.split("/").pop());
        let bots = await env.TELEGRAM_BOT_USERS.get("bots", "json") || {};
        const bot = bots[bot_name];
        if (!bot) {
          return jsonResponse({ok:false,error:"æœªé…ç½®è¯¥bot"},400);
        }
        const body = await request.json();
        if(!body.message) {
          return jsonResponse({ok:false,error:"éæ¶ˆæ¯"},200);
        }
        const msg = body.message;
        const from = msg.from;
        const isAdmin = bot.admins.includes(from.id.toString());

        // ====== å¤„ç†å¯åŠ¨æ¶ˆæ¯ /start å›¾ç‰‡/çº¯æ–‡å­— ======
        if (msg.text && msg.text.trim().startsWith("/start")) {
          let startmsg = await env.TELEGRAM_BOT_USERS.get(`startmsg_${bot_name}`, "json");
          if (!startmsg || !startmsg.type || startmsg.type === "none" || !startmsg.fileUrl) {
            const text = (startmsg && startmsg.caption) ? startmsg.caption : "æ¬¢è¿ä½¿ç”¨æœ¬æœºå™¨äººï¼";
            await fetch(`https://api.telegram.org/bot${bot.token}/sendMessage`, {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({
                chat_id: msg.chat.id,
                text
              })
            });
            return new Response("ok");
          }
          // å›¾ç‰‡
          if (startmsg.type === "photo" && startmsg.fileUrl) {
            await fetch(`https://api.telegram.org/bot${bot.token}/sendPhoto`, {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({
                chat_id: msg.chat.id,
                photo: startmsg.fileUrl,
                caption: startmsg.caption || ""
              })
            });
            return new Response("ok");
          }
          return new Response("ok");
        }

        // ====== å…³é”®è¯è‡ªåŠ¨å›å¤ï¼Œç®¡ç†å‘˜ä¹Ÿæ”¶åˆ°æé†’ ======
        let keywords = [];
        try {
          let kdata = await env.TELEGRAM_BOT_USERS.get(`keywords_${bot_name}`, "json");
          if (kdata && Array.isArray(kdata)) keywords = kdata;
        } catch(e){}
        let matched = keywords.find(item =>
          item.type==="equal" && msg.text && msg.text.trim() === item.keyword.trim()
        );
        if (!matched) {
          matched = keywords.find(item =>
            item.type==="contain" && msg.text && msg.text.includes(item.keyword)
          );
        }
        if (matched) {
          // 1. è‡ªåŠ¨å›å¤ç»™å®¢æˆ·
          await fetch(`https://api.telegram.org/bot${bot.token}/sendMessage`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
              chat_id: msg.chat.id,
              text: matched.reply
            })
          });
          // 2. é€šçŸ¥æ‰€æœ‰ç®¡ç†å‘˜ï¼ˆå¸¦#idï¼Œæ”¯æŒå›å¤è½¬å‘ï¼‰
          const showName = msg.from.username ? `@${msg.from.username}` : (msg.from.first_name || "") + (msg.from.last_name || "");
          for (const admin_id of bot.admins) {
            await fetch(`https://api.telegram.org/bot${bot.token}/sendMessage`, {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify({
                chat_id: admin_id,
                text: `ã€å…³é”®è¯è‡ªåŠ¨å›å¤æé†’ã€‘\næ¥è‡ªï¼š${showName} [${msg.from.id}]\næ¶ˆæ¯å†…å®¹ï¼š${msg.text}\nè§¦å‘å…³é”®è¯ï¼š${matched.keyword}\nè‡ªåŠ¨å›å¤ï¼š${matched.reply}\n#id${msg.from.id}`
              })
            });
          }
          // å‘½ä¸­å…³é”®è¯å›å¤åç›´æ¥returnï¼Œä¸å†èµ°åç»­å®¢æœé€»è¾‘
          return new Response("ok");
        }

        // ========== å®¢æˆ·æ¶ˆæ¯è½¬å‘ç»™æ‰€æœ‰ç®¡ç†å‘˜ ==========
        if (!isAdmin) {
          // è®°å½•å®¢æˆ·ID
          await env.telegram_bot.prepare(
            "INSERT OR IGNORE INTO chat_logs (bot_name, user_id) VALUES (?,?)"
          ).bind(bot_name, from.id).run();

          const showName = from.username ? `@${from.username}` : (from.first_name || "") + (from.last_name || "");
          const admin_caption = `ğŸ‘† ${showName} [${from.id}] å‘é€çš„æ¶ˆæ¯ #id${from.id}\nğŸ‘‰ å›å¤æ­¤æ¶ˆæ¯å³å¯å›å¤ç”¨æˆ·`;

          for (const admin_id of bot.admins) {
            if (msg.photo) {
              const photoFileId = msg.photo[msg.photo.length-1].file_id;
              await fetch(`https://api.telegram.org/bot${bot.token}/sendPhoto`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                  chat_id: admin_id,
                  photo: photoFileId,
                  caption: admin_caption + (msg.caption ? ("\n" + msg.caption) : "")
                })
              });
            } else if (msg.document) {
              await fetch(`https://api.telegram.org/bot${bot.token}/sendDocument`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                  chat_id: admin_id,
                  document: msg.document.file_id,
                  caption: admin_caption + (msg.caption ? ("\n" + msg.caption) : "")
                })
              });
            } else if (msg.text) {
              await fetch(`https://api.telegram.org/bot${bot.token}/sendMessage`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                  chat_id: admin_id,
                  text: admin_caption + "\n" + msg.text
                })
              });
            } else {
              // å…¶å®ƒç±»å‹ï¼Œå…œåº•
              await fetch(`https://api.telegram.org/bot${bot.token}/sendMessage`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                  chat_id: admin_id,
                  text: admin_caption + "\n[æ”¶åˆ°æœªçŸ¥ç±»å‹æ¶ˆæ¯]"
                })
              });
            }
          }
        }

        // ========== ç®¡ç†å‘˜å›å¤ï¼ˆè½¬å‘ç»™å®¢æˆ·ï¼‰ ==========
        else {
          // åªå¤„ç†â€œå›å¤æŸæ¡æ¶ˆæ¯â€æƒ…æ™¯
          let foundId = null;
          if (msg.reply_to_message && msg.reply_to_message.caption) {
            // ä¼˜å…ˆä»captionä¸­æ‰¾ #id
            const m = msg.reply_to_message.caption.match(/#id(\d+)/);
            if (m) foundId = m[1];
          }
          if (!foundId && msg.reply_to_message && msg.reply_to_message.text) {
            const m = msg.reply_to_message.text.match(/#id(\d+)/);
            if (m) foundId = m[1];
          }
          if (foundId) {
            const target_id = foundId;
            // æ”¯æŒå¤šç§ç±»å‹
            if (msg.text) {
              await fetch(`https://api.telegram.org/bot${bot.token}/sendMessage`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({chat_id: target_id, text: msg.text})
              });
            }
            if (msg.photo) {
              await fetch(`https://api.telegram.org/bot${bot.token}/sendPhoto`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({chat_id: target_id, photo: msg.photo[msg.photo.length-1].file_id, caption: msg.caption || ""})
              });
            }
            if (msg.document) {
              await fetch(`https://api.telegram.org/bot${bot.token}/sendDocument`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({chat_id: target_id, document: msg.document.file_id, caption: msg.caption || ""})
              });
            }
          }
        }

        return new Response("ok");
      }

      return jsonResponse("Not found",404);

    } catch(e) {
      // å…¨å±€å¼‚å¸¸æ•è·
      console.log("Global error:", e && e.stack ? e.stack : e);
      return jsonResponse({ok:false,error:e && e.message ? e.message : (""+e)}, 500);
    }
  }
}